# Фактор {}


```{r, out.width=c('100%'), echo=F, message=F}
knitr::include_graphics(here::here("images", "Factors_1500x500.png"))
```

Боломжит утгууд тодорхой байдлаар багцлагдан, эрэмбэлэн ангилагдсан датаг R дээр *фактор* дата гэнэ.

График, хүснэгт байгуулахад default-аар цагаан толгойн дарааллаар, багаас ихрүү чиглэлтэй (alpha-numeric) гарч ирдэг. Харин баганын утгад эрэмбэ (*шатлал*) тогтоосноор болиулж болдог. Үүний тулд карактер, тоон багануудыг фактор хэлбэрт хувиргах ашаардлагатй. Фактор датаны өөр ач холбогдол бол графикт стандарт легендийг байгуулж өгдөг. Энэ нь датанд аль нэг утга байхгүйгээс легендийн байрлал график янз бүр болж өөрчлөгдөөд байдаг асуудлыг шийдэж өгдө.


Энэ хэсэгт **forcats** багцын функцууд ( “**For** "**cat**egorical variables”-гэсэн үгийн товчлол) болон **base** R- зарим функцыг тайлбарлана. Мөн тархварзүйн долоо хоногтой (epiweeks) хэсэгт **lubridate**, **aweek** гэсэн багцуудаас цухас яригдах болно. 


**forcats** багц дах функцуудын бүрэн жагсаалтыг [here](https://forcats.tidyverse.org/reference/index.html) –ээс үзэж болно. Энд Энд зөвхөн чухал хэрэглэгддэг функцуудыг тайлбарласан.


<!-- ======================================================= -->
## Бэлтгэл  

### Багцыг ачааллах {.unnumbered}  

Энэ хэсэгт анализ хийхэд шаардлагатай багцуудыг доорхи кодоор ачааллана.**pacman** багцын `p_load()` функцээр шаардлагатай багцыг татаж аваад ачааллана уу. Өмнө татаж авсан багцуудаа **base** R -ын `library()`-аар ачааллаж болно. Багцын талаарх нэмэлт мэдээллийг [R basics] хэсгээс харна уу.

```{r}
pacman::p_load(
  rio,           # импорт/экспорт
  here,          # файлын зам
  lubridate,     # огноог янзлана
  forcats,       # факторыг янзлана
  aweek,         # автоматаар фактор үүсгэж тархварзүйн долоо хоног (epiweeks) үүсгэнэ
  janitor,       # хүснэгт
  tidyverse      # дата менежмент, график
  )
```



### Дата импортлох{.unnumbered}  

Жишээ дасгалуудад Эбола дэгдэлтийн үеийн зохиомол дата ашиглах болно. Эдгээр дасгалуудыг дагаж хийхийг хүсвэл <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds' class='download-button'>линкийн "clean" linelist дээ дарж татаж авна уу </a> (as .rds file). Датагаа **rio**-ын `import()`функцээр импортлож болно (энэ нь.xlsx, .rds, .csv - зэрэг олон дата төрөлтэй ажиллаж чадна. [Import and export] хэсэгт илүү тайлбарласан).  

```{r, echo=F}
# linelist -ийг R луу импортлох
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))
```


```{r, eval=F}
# датаг импортлох
linelist <- import("linelist_cleaned.rds")
```


### Шинээр ангилагдсан (categorical) хувьсагч үүсгэх {#fct_newcat .unnumbered}  

Ойлгомжтой тайлбарлах үүднээс хамгийн нийтлэг хэрэглэгддэг үйлдэл болох ангилагдсан хувьсагч шинээр хэрхэн үүсгэхийг үзэх болно.

Тоон баганыг фактор хэлбэрт хувиргаснаар статистик бодолт хийх боломжгүй өолдог гэдгийг санаарай.

#### Багана үүсгэх{.unnumbered}  

Жишээгээр `days_onset_hosp` (өвчний шинж эхэлснээс эмнэлэгт хэвтэх хүртэл хугацаа) баганын мөрүүдийг ангилан ялгаж `delay_cat` гэсэн шинэ багана үүсгэх болно. Үүнийг  **dplyr** -ын `case_when()` функцээр хйинэ. `case_when()` функцын логик шалгуур (баруун тал) дэс дарааллан мөр болгонд үйлчилж, үүссэн утга нь `delay_cat` шинэ баганын (зүүн тал) тохирох мөрөнд ордог. `case_when()` функцын талаар [Cleaning data and core functions] хэсэгт дэлгэрэнгүй тайлбарласан.  

```{r}
linelist <- linelist %>% 
  mutate(delay_cat = case_when(
    # шалгуур                                   # TRUE байвал орох шинэ утга 
    days_onset_hosp < 2                        ~ "<2 days",
    days_onset_hosp >= 2 & days_onset_hosp < 5 ~ "2-5 days",
    days_onset_hosp >= 5                       ~ ">5 days",
    is.na(days_onset_hosp)                     ~ NA_character_,
    TRUE                                       ~ "Check me"))  
```


#### Утгын default эрэмбэ {.unnumbered}  

`case_when()`-ээр үүсгэдсэн `delay_cat` багана карактер утгатай ангилагдсан багана байдаг. Өөрөөр хэлбэл фактор болж *амжаагүй* байдаг. Тийм ч учраас давтамж харуулсан хүснэгт дээр ангилалын жагсаалт цагаан толгойн дарааллаар эрэмбэлэгдсэн байдаг. Гэтэл энэ дараалал тухайн датаг ойлгоход учир дутагдалтай байдаг:  

```{r}
table(linelist$delay_cat, useNA = "always")
```

Barplot байгуулахад x-тэнхлэгийн дараалал автомат тохируулгатай байдаг ( R график байгуулахын тулд хамгийн их хэрэглэгддэг  **ggplot2** багцын талаар [ggplot basics] хуудасанд дэлгэрэнгүй тайлбарласан).  

```{r, warning=F, message=F}
ggplot(data = linelist)+
  geom_bar(mapping = aes(x = delay_cat))
```



## Фактор болгож хувиргах  

Карактер эсвэл тоон баганыг *фактор* болгож хувиргахад  **forcats** -ын аль ч функцыг хэрэглэж болно (дэлгэрэнгүй мэдээлэл  [below](#fct_adjust) -д орсон). Эдгээр функц нь датаг юуны түрүүнд фактор болгож хувиргадаг тул цаашид шатлалтай ангилал үүсгэх боломжтой болдог. Тухайлбал шатлалын эрэмбийг `fct_relevel()` -ээр зааж өгч болно. Гэтэл `as_factor()` функц зөвхөн факторт хувиргахаас өөр үйлдэл нэмж хийдэггүй. 

**base** R -ын `factor()` функц мөн баганыг факторлуу хувиргадаг ба шатлалын эрэмбийг `levels = ` аргументэд нь та өөрөө зааж өгөх болно. 

Дор жишээнд `mutate()` болон `fct_relevel()` -ээр `delay_cat` баганыг карактерээс фактор болгож хувиргахыг харуулав. `delay_cat` багана үүсэх талаар өмнөх [Preparation](#fct_newcat) хэсэгт тайлбарласан. 

```{r}
linelist <- linelist %>%
  mutate(delay_cat = fct_relevel(delay_cat))
```

*Одоо энэхүү баганын "утгууд" фактор "түвшингүүд" боллоо гэсэн үг.*  Энэхүү үүсгэсэн түвшний жагсаалтыг *эрэмбийг* **base** R-ын  `levels()` функц эсвэл `table()` эсвэл **janitor** -ын `tabyl()` функцуудээр харж болно. Түвшний эрэмбэ нь default-аар цагаан толгойн болон багаас ихсэх (alpha-numeric) дарааллар гарч ирдэг. `NA` бол факторын түвшинд тооцогдохгүй болохыг анхаарна уу.   

```{r}
levels(linelist$delay_cat)
```

Үүнээс гадна `fct_relevel()` -ээр түвшний эрэмбийг гараар зааж өгч болно. Ингэхдээ доор үзүүлсний дагуу түвшин заасан утгуудаа таслалаар тусгаарлаж, хашилтанд уагсааж бичнэ. Датан дах утгаасаа үг үсгийн зөрөөгүй бичхийг анхаар. Хэрэв датанд байхгүй түвшин үүсгэх хэрэгтэй бол [`fct_expand()` instead](#fct_add))-ыг хэрэглэ.  

```{r}
linelist <- linelist %>%
  mutate(delay_cat = fct_relevel(delay_cat, "<2 days", "2-5 days", ">5 days"))
```

Дээрх коммандаар зааж өгсний үр дүнд түвшний эрэмбэ илүү ойлгомжтой болно байна. 

```{r}
levels(linelist$delay_cat)
```

График дээр хэвлэгдэх дараалал ч гэсэн илүү ойлгомжтой болж байна.  

```{r, warning=F, message=F}
ggplot(data = linelist)+
  geom_bar(mapping = aes(x = delay_cat))
```


## Түвшин нэмэх, хасах 

### Нэмэх {#fct_add .unnumbered}
Фактортоо нэмж түвшин оруулах бол `fct_expand()`-ыг хэрэглэ. Багана болон нэмэгдэж буй түвшний нэрийг (таслалаар тусгаарлаж) функцэл оруулдаг. Баганын нийт утгыг хүснэгтэлж харвал шинээр үүсгэсэн түвшин 0 давтамжтай харагддаг. **base** R-ын `table()` эсвэл **janitor**-ын `tabyl()` -аар хүснэгт болгож хараарай:  

```{r}
linelist %>% 
  mutate(delay_cat = fct_expand(delay_cat, "Not admitted to hospital", "Transfer to other jurisdiction")) %>% 
  tabyl(delay_cat)   # хүснэгт хэвлэ
```


Тэмдэглэл: **forcats** -д дутуу утгыг (`NA`) хялбар аргаар түвшин болгож хувиргах тусгай функц байдаг. [Missing values](#fct_missing) хэсгийг нэмж үзнэ үү.  


### Хасах {.unnumbered}  

`fct_drop()`-ээр "ашиглагдаагүй", 0 давтамжтай түвшинг хасдаг.  Өмнөх жишээний нэг түвшин ("эмнэлэгт хэвтээгүй тохиолдлууд") 0 давтамжтай байна. Фактортай баганаа `fct_drop()`-д оруулснаар энэхүү 0 давтамжтай түвшин хасагдна:  

```{r}
linelist %>% 
  mutate(delay_cat = fct_drop(delay_cat)) %>% 
  tabyl(delay_cat)
```




## Түвшний эрэмбийг тохируулах {#fct_adjust} 

**forcats** -ын функцуудээр түвшний эрэмбийг тохируулахад хялбар (багана фактор хэлбэрт хувирсан байх шаардлагатай): 

Ингэхдээ фактор баганад хоёр янзаар үйлчилнэ:  

1) Хүснэгтийн багана: датанд өөрчлөлт хийгдсэн тул цаашид хийгдэх үйлдэлд нөлөөлнө.  
2) *График дотор*: өөрчлөлт зөвхөн график дотор хийгдэх болно.  



### Гараар гүйцэтгэх {.unnumbered} 

Фактор дах түвшний эрэмбийг гараар янзалж болно. Фактор бус баганыг функцэд оруулбал багана эхлээд фактор хэлбэрт хувирдаг.  

Хаалтан дотор баганын нэрийг оруулаад араас нь дараахь хоёрын аль нэгийг оруул:  

* Түвшнүүдийг бүгдийг хүссэн дарааллын дагуу жагсааж оруулна (карактер вектор хэлбэрээр `c()`) эсвэл  
* Засагдах шаардлагатай нэг ширхэг түвшний нэрийг оруулаад түүний шинэ эрэмбийн байрлалыг `after = ` аргументэд зааж өгнө.  

Энэхүү жишээнд `delay_cat` баганын түвний эрэмбийг дахин зааж өгч (өмнө нь фактор байсан) хүссэн дарааллалдаа хэрхэн оруулахыг харуулав. 

```{r}
# түвшний эрэмбийг дахин зааж өгөх
linelist <- linelist %>% 
  mutate(delay_cat = fct_relevel(delay_cat, c("<2 days", "2-5 days", ">5 days")))
```

Зөвхөн нэг л түвшинг зөөх шаардлагатй үед `fct_relevel()` -ыг дангаар нь хэрэглэж,  засагдах эрэмбийн байрлалыг `after = ` аргументэд зааж өг. Жишээ нь дараахь коммандаар "<2 days" гэсэн түвшин хоёрдугаар байрлалруу зөөгдөж байна: 

```{r, eval=F}
# түвшний эрэмбийг дахин зааж өгч
linelist %>% 
  mutate(delay_cat = fct_relevel(delay_cat, "<2 days", after = 1)) %>% 
  tabyl(delay_cat)
```




### График дотор {.unnumbered}  

Хүснэгтээс гадна график доторх түвшний эрэмбийг **forcats** -аар зааж өгдөг. Эдгээр функцыг график байгуулдаг `ggplot()` дотор оруулаад түвшнийг эрэмбэлж, урвуулж (reverse) болно. Ингэснээр өөрчлөлт зөвхөн графикт л хийгдэх болно. 

Доор жишээнд хоёр графикийг`ggplot()` -ээр байгуулав ( [ggplot basics] хуудсаас лавлаж болно). Эхний графикт `delay_cat` баганыг x-тэнхлэгт байрлуулж,  түвшний эрэмбэ нь default хэлбэрээр байна. Хоёр дах графикийн кодонд баганын нэр, түвшний дарааллыг `fct_relevel()`-т оруулснаас график дээрх эрэмбэ өөрчлөгдсөн байна. 

```{r, echo =F}
linelist <- linelist %>% 
  mutate(delay_cat = fct_relevel(delay_cat, c("2-5 days", "<2 days", ">5 days")))

```



```{r, warning=F, message=F, out.width = c('50%', '50%'), fig.show='hold'}
# ggplot дотор тохируулга хийж өгөөгүй учир эрэбмэ default буюу цагаан толгойн, багаас ихсэх дараалалтай байна 
ggplot(data = linelist)+
    geom_bar(mapping = aes(x = delay_cat))

# фактор лах түвшний эрэмбийг ggplot дотор тохируулж өгсөн
ggplot(data = linelist)+
  geom_bar(mapping = aes(x = fct_relevel(delay_cat, c("<2 days", "2-5 days", ">5 days"))))
```

графикийн түвшинд ингэж өөрчлөлт хийхэд x- тэнхлэг дээрх default гарчигны утга алдагддаг. Иймээс гарчигийг **ggplot2**-ын  `labs()` аргументээр дахин нэрлэх хэрэгтэй. 




### Урвуулах {.unnumbered}  

Түвшний эрэмбийг урвуугаар нь эрэмбэлэх хэрэгцээ их байдаг. Энэ үед факторыг `fct_rev()`-т оруулж бичихэд хангалттай.  

Дата доторх факторын эрэмбэ нь хэвээр боловч графикт харагдах эрэмбэд өөрчлөлт оруулах гэж буй бол `guides()` функцыг хэрэглэж болно ([ggplot tips] хэсгээс харна уу).  




### Давтамжаар {.unnumbered}  

Датаны давтамжийн тоогоор эрэмбэлэхдээ `fct_infreq()`-ийг хэрэглэдэг. Дутуу утгад (`NA`) тодорхой түвшин зааж өгөөгүй тохиолдолд автоматаар хамгийн төгсгөлд эрэмбэлэгддэг ([this section](#fct_missing) -ээс харна уу). Давтамжийн урвуу дараалалд оруулах бол `fct_rev()`-т давхар оруулж эрэмбэлдэг.   

Энэ функцыг доор үзүүлсэнчлэн `ggplot()`дотор хэрэглэж болно.  

```{r, out.width = c('50%', '50%', '50%'), fig.show='hold', warning=F, message=F}
# давтамжаар нь эрэмбэлэх
ggplot(data = linelist, aes(x = fct_infreq(delay_cat)))+
  geom_bar()+
  labs(x = "Delay onset to admission (days)",
       title = "Ordered by frequency")

# урвуу давтамжаар эрэмбэлэх
ggplot(data = linelist, aes(x = fct_rev(fct_infreq(delay_cat))))+
  geom_bar()+
  labs(x = "Delay onset to admission (days)",
       title = "Reverse of order by frequency")
```


### Харагдах байдлаар {.unnumbered}  

Датанд эхэлж гарч ирэх дарааллаар (эхний мөрөөс эхэлж тооцно) эрэмбэлэхийн тулд `fct_inorder()`-ийг хэрэглэ. Датаг `arrange()` функцээр эхэлж эрэмбэлээд, факторт хувиргаж буй үед `fct_inorder()`  функц илүү хэрэг болдог. 




### Өөр баган дах статистикийн тооцооллоор {.unnumbered}  

Сонгосон баганын түвшинг *өөр баганын статистикийн тооцооллын* дагуу эрэмбэлэхдээ `fct_reorder()`-ыг ашигладаг. Ингэж эрэмбэлэхэд аажмаар өгсөж, буурсан bars/цэгэн график байгуулагдаж харахад илүү ойлгомжтой болдог. 

Жишээнд x-тэнхлэгт `delay_cat` гэсэн фактор багана y-тэнхлэгт `ct_blood` гэсэн тоон багана байрлуулав (босго утга). `delay_cat` -ын бүлэг тус бүрт boxplot-оор CT -ыг дүнг байна. Жишээнд үүнийг CT үр дүнгийн медиан дүнгийн өгсөх дарааллаар эрэмбэлэгдсэн boxplots болгож хувиргав.

Эхний графикт түвшингүүд цагаан толгойн, багаас ихсэх тоон дарааллаар (alpha-numeric) эрэмбэлэгдсэн. Тиймээс boxplot -ын өндөр янз бүр холилдсон, тодорхой дараалалгүй харагдаж байна. Хоёрдах жишээнд  `delay_cat` баганыг  (x-тэнхлэгдэх)  `fct_reorder()` дотор оруулж, `ct_blood` баганыг араас нь хоёр дах аргументээр зааж өгч, "median" -ийг гуравдах аргументээр өгсөн байна (мөн "max", "mean", "min" зэргийг хэрэглэж болно). Тиймээс `delay_cat` түвшний дараалал нь `delay_cat` бүлэг бүрийн дундаж CT утгын өсөх дундаж CT утгыг тусгах болно. Үүнийг хоёр дах график дээрээс харж болно. Boxplot -ууд  өгсөх дарааллаар эрэмбэлэгдсэн байна. Хэрэв `NA` -г (дутуу утга) тодорхой түвшинд хуваарилаагүй болавтоматаар хамгийн сүүлд эрэмбэлэгддэг.  

```{r, fig.show='hold', message=FALSE, warning=FALSE, out.width=c('50%', '50%')}
# анхны дарааллаар эрэмбэлэгдсэн boxplots 
ggplot(data = linelist)+
  geom_boxplot(
    aes(x = delay_cat,
        y = ct_blood, 
        fill = delay_cat))+
  labs(x = "Delay onset to admission (days)",
       title = "Ordered by original alpha-numeric levels")+
  theme_classic()+
  theme(legend.position = "none")


# CT баганын median утгаар эрэмбэлэгдсэн boxplots
ggplot(data = linelist)+
  geom_boxplot(
    aes(x = fct_reorder(delay_cat, ct_blood, "median"),
        y = ct_blood,
        fill = delay_cat))+
  labs(x = "Delay onset to admission (days)",
       title = "Ordered by median CT value in group")+
  theme_classic()+
  theme(legend.position = "none")
```

Энэ үйлдлийг хийхэд `ggplot()` коммандын өмнө ямар нэгэн нэмэлт үйлдлэл хийгдэх шаардлагагүй. Бүлэглэж, тооцоолол хийх үйлдлүүд бүгд ggplot комманд дотроо хийгддэг. 


### "Сүүлийн" утгаар {.unnumbered}  

Бүлэглэсэн шугаман графикт `fct_reorder2()` -ыг хэрэглэж болно. Энэ функц график дах шугамын "төгсгөлийн" хэсгийн түвшингүүдийг (мөн *легенд*) босоо тэнхлэгийн дагуу эрэмбэлдэг. Өөрөөр хэлбэл x-тэнхлэг дэх утгын хамгийн ихтэй хамааралтай y-утгыг эрэмбэлнэ гэсэн үг.

Жишээ нь өвчлөлийн бодит тоог эмнэлг тус бүрээр бүлэглэж цаг хугацаагаар харуулсан график байгуулахаар болов. Ингэхдээ `aes()` доторх `color = ` аргументэд `fct_reorder2()`-тай синтаксаа оруулбал легендийн босоо тэнхлэгийн эрэмбэ графикийн төгсгөлийн босоо тэнхлэгт харагдах эрэмбэтэй ижил болдог. Энэ талаар [online documentation](https://forcats.tidyverse.org/reference/fct_reorder.html) материалаас уншна уу.  

```{r, warning=F, message=F}
epidemic_data <- linelist %>%         # linelist-ээр эхэл
    filter(date_onset < as.Date("2014-09-21")) %>%    # харахад ойлгомжтой болхын тулд босго огноо өг
    count(                                            # долоо хоног тутам, эмнэлэг тус бүрээр харуулах
      epiweek = lubridate::floor_date(date_onset, "week"),  
      hospital                                            
    ) 
  
ggplot(data = epidemic_data)+                       # график байгуулж эхлэх
  geom_line(                                        # шугам хийх
    aes(
      x = epiweek,                                  # тархварзүйн долоо хоногийн х-тэнхлэг
      y = n,                                        # өндрөөр долоо хоног тутам дах бодит тоог илэрхийлнэ
      color = fct_reorder2(hospital, epiweek, n)))+ # эмнэлэг тус бүрээр датаг бүлэглэж өнгөөр ялгана. Графикийн төгсгөлийн тооны эрэмбээр факторын эрэмбийг тодорхойлно
  labs(title = "Factor levels (and legend display) by line height at end of plot",
       color = "Hospital")                          # легендийн гарчигийг өөрчлөх
```




## Дутуу утга {#fct_missing}  

фактор багана дутуу утгатай (`NA`) бол `fct_explicit_na()`-аар `NA`-г түвшин болгож нэр ("Missing" ) өгч болно. Default-аар хамгийн ард орж эрэмбэлэгддэг. Нэрийг нь  `na_level = ` аргументээр өөрчилж болно.  

Дээрх үйлдлийг `delay_cat` дээр туршиж, `tabyl()` -аар хүснэгтлэн хэвлэхэд `NA` "Missing delay" гэж нэрлэгдсэн буйг харж байна. 
```{r}
linelist %>% 
  mutate(delay_cat = fct_explicit_na(delay_cat, na_level = "Missing delay")) %>% 
  tabyl(delay_cat)
```





## Түвшнүүдийг нэгтгэх  


### Гар аргаар {.unnumbered}  

Түвшний харагдах байдлыг `fct_recode()`-ыг ашиглаж гараар янзалдаг. Энэ нь **dplyr** -ын `recode()` функцтэй адил ([Cleaning data and core functions]-ээс хар) боловч `fct_recode()` -ыг хэрэглэснээр шинэ фактор түвшин үүсгэх боломжтой байдгаараа ач холбогдолтой. Ердийн `recode()`-ийг хэрэглэхэд шинэ утгыг хүлээж авдгүй ба нэмэлт тохируулга хийж байж боломжтой болдог.  

Энэхүү функцээр олон түвшинд ижил утга оруулж түвшнүүдийг "нэгтгэж" болно. Ингэхдээ хэрэгтэй мэдээлэл санамсаргүй утгагдхаас болгоомжил! Шинэ багана үүсгэн түвшнүүдийг нэгтгэвэл эрсдэл багатай (хуучих багана дээрээс бичигдэхгүй).  

`fct_recode()` -ын синтакс `recode()`-оос өөр. `recode()` -оор `ХУУЧИН = ШИНЭ`гэсэн дараалалтай бол `fct_recode()` нь `ШИНЭ = ХУУЧИН` гэсэн дараалалтай.     

Эхлээд `delay_cat` -ын түвшин дараах байдалтай байна:  
```{r, echo=F}
linelist <- linelist %>% 
  mutate(delay_cat = fct_relevel(delay_cat, "<2 days", after = 0))
```


```{r}
levels(linelist$delay_cat)
```

Шинэ түвшинг `fct_recode(column, "new" = "old", "new" = "old", "new" = "old")` гэсэн синтаксаар үүсгэж хэвлэв:  

```{r}
linelist %>% 
  mutate(delay_cat = fct_recode(
    delay_cat,
    "Less than 2 days" = "<2 days",
    "2 to 5 days"      = "2-5 days",
    "More than 5 days" = ">5 days")) %>% 
  tabyl(delay_cat)
```

Энд дээрх түвшнийг `fct_recode()` -оор нэгтгэв. "Less than 5 days" түвшинг шинээр нэмхэд алдаа гарч анхааруулж байна.


```{r, warning=F, message=F}
linelist %>% 
  mutate(delay_cat = fct_recode(
    delay_cat,
    "Less than 5 days" = "<2 days",
    "Less than 5 days" = "2-5 days",
    "More than 5 days" = ">5 days")) %>% 
  tabyl(delay_cat)
```





### "Бусад" болгож хумих {.unnumbered}  

Гараар "Бусад" гэсэн түвшин үүсгэх бол `fct_other()` функцыг хэрэглэж болно. Дор жишээнд `hospital` баганын "Port Hospital" болон "Central Hospital" түвшнээс бусад түвшингүүд "Other" болж нэтггэдсэн байна. Энэ үед хасах, нэмэх шаардлагатай утгаа `keep = ` эсвэл `drop = `-аргументэд вектор хэлбэрээр зааж өгч болно. "Бусад" гэсэн түвшний харагдах байдлыг `other_level = `гэсэн аргументээр өөрчилж болно.  

```{r}
linelist %>%    
  mutate(hospital = fct_other(                      # түвшнүүдийг тохируул
    hospital,
    keep = c("Port Hospital", "Central Hospital"),  # тусдаа утгуудыг оруул
    other_level = "Other Hospital")) %>%            # Бусад бүх утгыг "Other Hospital" болго
  tabyl(hospital)                                   # хүснэгтийг хэвлэ

```




### Давтамжаар нь хумих {.unnumbered}

Хамгийн бага давтамжтай түвшнүүдийг `fct_lump()`-ээр зэрэг нэгтгэж болдог.  

Бага давтамжтай бүлгүүдийг зэрэг "бөөндөж" нэгтгэн "Other" түвшин үүсгэхийн тулд дараах үйлдлүүдээс сонгож хийнэ үү:  

* `n = ` -ээр хэдэн бүлэг үүсгэхээ зааж өгнө. Ингэснээр хамгийн их давтамжтай n бүлэг үлдэж, үлдсэн хэсэг нь "Other" бүлэгт нэтгэгднэ
.  
* `prop = ` -ыг тохируул. Үлдээх гэж буй түвшний давтамжид босго хувь зааж өг. Энэхүү босго хувиас бага утгууд "Other" болж нэгтгэгднэ.

"Other" түвшний харагдах байдлыг `other_level = ` аргументээр тохируулж өөрчилж болно. Доорх жишээнд хамгийн их давтамжтай хоёр эмнэлэгээс бусад нь "Other Hospital" болж нэтгэгдсэн.

```{r, warning=F, message=F}
linelist %>%    
  mutate(hospital = fct_lump(                      # түвшнүүдийг тохируул
    hospital,
    n = 2,                                          # дээрээсээ эхний хоёр түвшинг үлдээ
    other_level = "Other Hospital")) %>%            # бусдыг нь "Other Hospital"-т нэгтгэ
  tabyl(hospital)                                   # хүснэгтийг хэвлэ

```




, warn
## Бүх түвшнийг харуул  

Фактор хэрэглэхийн бас нэг ач холбогдол нь датанд ямар утга байгаагаас үл хамааран графикийн легенд болон тайлангийн хүснэгтийг жигд, стандарт болгож өгдөг. 

Олон график, зураг зэрэг бэлдэж буй үед (графикийг газар нутгаар нь ялгаж харуулах гэх мэт) легенд, тайлангийн хүснэгтийг яг адилхан байлгах шаардлагатй болдог (датанд зарим утгы нь өөр байсан ч гэсэн).  

### Графикт {.unnumbered}  

Үүний тулд `ggplot()`-ын тохируулгын нэг `scale_xxxx()` функцуудэд `drop = FALSE` гэсэн аргументийг нэмдэг. Ингэснээр датанд байхгүй ч гэсэн факторын бүх түвшин графикт гарч ирдэг. Фактор баганын түвшин `fill = ` аргументэд орсон үед scale_fill_discrete() дотор `drop = FALSE` гэж өгнө (доор харуулсан). Түвшингүүдийг `x = `(x-тэнхлэг) ,`color = `, `size = `-нарт оруулсан үед `drop = FALSE`-ыг `scale_color_discrete()` эсвэл `scale_size_discrete()` -д оруулна.  

Жишээнд насны ангиллыг эмнэлэг тус бүрээр давхар bar plot -д оруулж харуулсан. Үүн дээр `scale_fill_discrete(drop = FALSE)` гэж нэмснээр бүх насны бүлэг легенд дээр харагдаж байна (зарим нь датанд байхгүй ч гэсэн).

```{r}
ggplot(data = linelist)+
  geom_bar(mapping = aes(x = hospital, fill = age_cat)) +
  scale_fill_discrete(drop = FALSE)+                        # датанд байхгүй ч гэсэн легенд дээр бүх насны ангилал харагдна
  labs(
    title = "All age groups will appear in legend, even if not present in data")
```

### Хүснэгтэнд {.unnumbered}  

**base** R-ын `table()`болон **janitor**-ын `tabyl()` -ыг хэрэглэж бүх фактор түвшинг харуулдаг (хэрэглэгдээгүй түвшин ч гэсэн).  

Хэрэв хүснэгтийг **dplyr**-ын `count()` эсвэл `summarise()`-аар байгуулж буй бол `.drop = FALSE` гэсэн аргумент нэмж хэрэглэгдээгүй ч гэсэн бүх фактор түвшинг гарч ирэх болно.

[Descriptive tables] хуудас эсвэл [scale_discrete documentation](https://ggplot2.tidyverse.org/reference/scale_discrete.html), or the [count() documentation](https://dplyr.tidyverse.org/reference/count.html) линкээс нэмж уншна уу. [Contact tracing] хуудасны жишээг нэмж үзэж болно.  


## Тархвар зүйн долоо хоног  

Тархварзүйн долоо хоногийг хэрхэн байгуулах талаар [Grouping data] хуудаснт дэлгэрэнгүй бичсэн. Мөн [Working with dates] хуудаст тархварзүйн долоо хоногийг үүсгэж, хэлбэржүүлэх талаар оруулсан.


### График дээрх тархварзүйн долоо хоног  {.unnumbered}  

Тархварзүйн долоо хоногийг графикт харуулахдаа **lubridate**-ын `floor_date()` функцыг ([Grouping data] хуудаст тайлбарласан) хэрэглэж болно. Ингэснээр YYYY-MM-DD форматтай, огноо төрлийн дата үүсдэг. Ийм огноотой баганаар график байгуулвал эрэмбэ нь автоматаар зөв гарч ирдэг бөгөөд факторт хувиргаж, түвшинг эрэмбэлэх шаардлагагүй. Жишээнд өвчний эхэлсэн огноог `ggplot()` гистограммаар харуулав.  

Огнооны харагдах байдлыг `scale_x_date()` -ээр тохируулж болно. Энэ талаар [Epidemic curves] хуудаст дэлгэрүүлж бичсэн. `scale_x_date()` функцын `date_labels = ` аргументэд "strptime" гэсэн форматыг зааж өгдөг. Энэхүү формат "%" тэмдэгтийг огноог илэрхийлэх тэмдэг болгодог ( дэлгэрэнгүй мэдээллийг [Working with dates] хуудаст оруулсан). Тухайлбал "%Y" гэж бичвэл жилийг 4 цифрээр бичихийг, "%W" эсвэл "%U" -аар хэддүгээр долоо хоног болохыг зааж өгдөг (нэгдэх, бүтэнсайнаар эхэлдэг долоо хоног).  

```{r, warning=F, message=F}
linelist %>% 
  mutate(epiweek_date = floor_date(date_onset, "week")) %>%  # долоо хоногийн багана
  ggplot()+                                                  # ggplot-ыг эхэл
  geom_histogram(mapping = aes(x = epiweek_date))+           # өвчний эхлэлийн гистограмм
  scale_x_date(date_labels = "%Y-W%W")                       # огнооны форматыг YYYY-WWw болгоно
```


### Датандах тархварзүйн долоо хоног  {.unnumbered}  

Хэрэв таны гол зорилго график бүтээх *биш* бол дараах хоёр аргыг хэрэглэж болох юм:

1) *For fine control over the display*, convert the **lubridate** epiweek column (YYYY-MM-DD) to the desired display format (YYYY-WWw) *within the data frame itself*, and then convert it to class Factor.  

Эхлээд **base** R -ын `format()` -аар огнооны YYYY-MM-DD форматыг YYYY-Www болгож хувирга ([Working with dates] хуудсаас харна уу). Ингэснээр карактер төрлийн багана болж хувирна. Үүнийг `factor()`-аар фактор болгож хувирга.  


```{r}
linelist <- linelist %>% 
  mutate(epiweek_date = floor_date(date_onset, "week"),       # тархварзүйн долоо хоног үүсгэ (YYYY-MM-DD)
         epiweek_formatted = format(epiweek_date, "%Y-W%W"),  # Хувирга (YYYY-WWw)
         epiweek_formatted = factor(epiweek_formatted))       # Факторт хувирга

# Түвшнүүдийг харуул
levels(linelist$epiweek_formatted)
```

<span style="color: red;">**_АЮУЛТАЙ:_** Хэрэв та долоо хоногийн дугаарыг жилийн урд талд нь оруулбал  ("Www-YYYY") ("%W-%Y") default тохируулгаар (alpha-numeric) буруу эрэмбэлэгднэ (жишээ нь 01-2015 нь 35-2014 -ын урд талд бичигднэ). Үүнийг зөвхөн гараар янзалж болдог бөгөөд энэ нь маш их ажиллагаатай.</span>  

2) *For fast default display*, use the **aweek** package and it's function `date2week()`. Долоо хоногийн эхлэх өдрийг `week_start = ` аргументээр тохируулж болдог. Хэрэв `factor = TRUE` гэж тохируулбал үүсэх багана нь фактор болдог. Ингэснээр байж болох *бүх* долоо хоногийг оруулж болдог (тухайн долоо хоногт тохиолдол гараагүй байсан ч гэсэн ).
```{r, eval=F}
df <- linelist %>% 
  mutate(epiweek = date2week(date_onset, week_start = "Monday", factor = TRUE))

levels(df$epiweek)
```

[Working with dates] хуудаснаас  **aweek**-ийн талаар нэмж үзэж болно. Энэ багцад бас урвуу функц `week2date()` байдаг.  



<!-- ======================================================= -->
## Эх сурвалж {} 

R for Data Science номын  [factors](https://r4ds.had.co.nz/factors.html) хуудас 
[aweek package vignette](https://cran.r-project.org/web/packages/aweek/vignettes/introduction.html).
