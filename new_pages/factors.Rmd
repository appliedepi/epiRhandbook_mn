# Фактор {}


```{r, out.width=c('100%'), echo=F, message=F}
knitr::include_graphics(here::here("images", "Factors_1500x500.png"))
```

Боломжит утгууд тодорхой байдлаар багцлагдан, эрэмбэт ангилалд орсныг R дээр *фактор* дата гэж үзнэ.

График, хүснэгт байгуулахад гарч ирэх дараалал заавал цагаан толгойн дарааллаар гарч ирдэггүй болгохын тулд баганын утгад эрэмбэ (*шатлал*) тогтоох хэрэгтэй ба энэ үйлдлийг карактер, тоон утгатай багануудыг фактор хэлбэрт хувиргаж байж хийх боломжтой болдог. Фактор датаны өөр нэгэн хэрэглээ бол графикын легендийг жигд болгож өгдөг ба ингэснээр аль нэг дата дутлаа гэхэд легендийн байрлал дээш доош болж өөрлөгдөхгүй. 


Энэхүү хэсэгт **forcats** багцын функцууд ( “**For** "**cat**egorical variables”-гэсэн үгийн товчлол) болон **base** R- зарим функцыг тайлбарлана. Мөн тархварзүйн дотоо хоногтой хэсэгт **lubridate**, **aweek** гэсэн багцуудаас цухас яригдах болно. 


**forcats** багц дах функцуудын бүрэн жагсаалтыг [here](https://forcats.tidyverse.org/reference/index.html) –ээс үзэж болно. Энэхүү хэсэгт чухал хэрэглэгддэг функцуудыг тайлбарласан.


<!-- ======================================================= -->
## Бэлтгэл  

### Багцыг ачааллах {.unnumbered}  

Доорхи хэсэг код анализ хийхэд шаардлагатай багцуудыг ачааллаж өгнө. Энэхүү номонд бид голчлон **pacman** багцын `p_load()` функцээр шаардлагатай багцыг татаж аваад ачааллах болно. Өмнө татаж авсан багцуудаа **base** R -ын `library()` аар мөн ачааллаж болно. Багцын талаарх нэмэлт мэдээллийг [R basics] хэсгээс харна уу.

```{r}
pacman::p_load(
  rio,           # импорт/экспорт
  here,          # файлын зам
  lubridate,     # огноотой ажиллана
  forcats,       # факторццд
  aweek,         # автомат фактор үүсгэж тархварзүйн долоо хоног (epiweeks) үүсгэнэ
  janitor,       # хүснэгт
  tidyverse      # дата менежмент,график
  )
```



### Импорт дата {.unnumbered}  

Бид энэ хэсэгт Эболагийн дэгдэлтийн үеийн зохиомол датаг импорт хийж оруулах болно. Хэрэв дасгалуудыг дагаж хийх бол <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds' class='download-button'>линкийн "clean" linelist -ийг татаж авна уу </a> (as .rds file). Датагаа **rio**-ын `import()`функцээр импортлоно уу (энэ нь.xlsx, .rds, .csv - зэрэг олон дата төрөлтэй ажиллаж чадна. [Import and export] хэсгээс нэмэлт мэдээлэл үзнэ үү).  

```{r, echo=F}
# linelist -ийг R луу импортло
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))
```


```{r, eval=F}
# датагаа импортло
linelist <- import("linelist_cleaned.rds")
```


### Шинээр ангилагдсан (categorical) хувьсагч үүсгэх {#fct_newcat .unnumbered}  

Тайлбарлан үзүүлэх зорилгоор энэ хэсэгт нийтлэг хэрэглэгддэг үйлдлүүдийн нэг шинээр ангилагдсан хувьсагч үүсгэх болно.

Тоон утгатай баганыг фактор хэлбэрт хувиргасны дараа энэ баганын утгыг ашиглаж статистикийн бодолт хийх боломжгүй гэдгийг анхаарна уу.

#### Багана үүсгэх{.unnumbered}  

Энэ хэсэгт `days_onset_hosp` (өвчний шинж эхэлснээс эмнэлэгт хэвтэх хүртэл хугацаа) баганын мөрүүдийг хэдэн хэсэгт ангилж `delay_cat` гэсэн шинэ багана үүсгэх болно. Энэ үйлдлийг **dplyr** -ын `case_when()`функцээр хйинэ. `case_when()`функцын логик шалгуур (баруун тал) дэс дарааллан мөр болгонд үйлчилж, үүссэн утга нь `delay_cat` шинэ баганын (зүүн тал) тохирох мөрөнд ордог. `case_when()` функцын талаар [Cleaning data and core functions] хэсэгт дэлгэрэнгүй тайлбарласан.  

```{r}
linelist <- linelist %>% 
  mutate(delay_cat = case_when(
    # шалгуур                                   # TRUE байвал шинэ утга оруулна
    days_onset_hosp < 2                        ~ "<2 days",
    days_onset_hosp >= 2 & days_onset_hosp < 5 ~ "2-5 days",
    days_onset_hosp >= 5                       ~ ">5 days",
    is.na(days_onset_hosp)                     ~ NA_character_,
    TRUE                                       ~ "Check me"))  
```


#### Утгын default эрэмбэ {.unnumbered}  

Энэхүү шинээр үүссэн `delay_cat` нь `case_when()`-ээр үүсгэгдсэний дараа карактер төрлийн утгатай ангилагдсан багана болох ба фактор болж *амжаагүй* байдаг. Тиймээс давтамжийг харуулсан хүснэгтэд утгууд автоматаар цагаан толгойн дарааллаар жагсдаг. Гэтэд энэ дараалал тухайн датаг ойлгоход тус болдгүй:  

```{r}
table(linelist$delay_cat, useNA = "always")
```

Мөн bar график байгуулахад x-axis-т дээрх дараалал автоматаар гарч ирдэг ( R дээр хамгийн элбэг хэрэглэгддэг график байгуулах баг **ggplot2** ын талаар [ggplot basics] хуудаснаас уншна уу).  

```{r, warning=F, message=F}
ggplot(data = linelist)+
  geom_bar(mapping = aes(x = delay_cat))
```



## Фактор болгож хувиргах  

Карактер эсвэл тоон баганыг *фактор* болгож хувиргахад  **forcats** -ын багцн аль ч функцыг хэрэглэж болно (дэлгэрэнгүй мэдээллийг  [below](#fct_adjust) -ээс харна уу). Эдгээр функц эхлээд фактор болгож хувиргаад, тодорхой шатлалын дагуу ангилан эрэмбэлэх боломж өгдөг. Жишээ нь `fct_relevel()` -ийг хэрэглэж шатлалын эрэмбийг гараар зааж өгч болно. Харин `as_factor()` зөвхөн факторт хувиргахаас өөр үйлдэл нэмж хийдэггүй. 

**base** R -ын функц `factor()` баганыг факторлуу хувиргаад, шатлалын эрэмбийг `levels = ` аргументэд нь та өөрөө зааж өгөх хэрэгтэй байдаг. 

Дор жишээнд `mutate()` болон`fct_relevel()` -ээр `delay_cat` баганыг карактерээс фактор болгож хувиргах болно. Хэрхэн`delay_cat` багана үүссэнийг өмнөх [Preparation](#fct_newcat) хэсэгт тайлбарласан. 

```{r}
linelist <- linelist %>%
  mutate(delay_cat = fct_relevel(delay_cat))
```

*Одоо энэхүү баганын "утгууд" нь факторын "түвшингүүд" боллоо гэсэн үг.*  Энэхүү үүсгэсэн түвшний *эрэмбийг*  **base** R-ын  `levels()`функц эсвэл `table()` эсвэл **janitor** -ын `tabyl()` функцуудээр харж болно. Түвшний эрэмбэ нь default-аар цагаан толгойн дараалал, багаас ихсэх дарааллар гарч ирдэг. `NA` бол факторын түвшин биш болохыг анхаарна уу.   

```{r}
levels(linelist$delay_cat)
```

Үүнээс гадна `fct_relevel()` функцыг ашиглаж түвшний эрэмбийг гараар зааж өгч болно. Ингэхдээ доор үзүүлсний дагуу түвшин харуулсан утгуудаа таслалаар тусгаарлаж жагсаагаадхашилтанд оруулж бичнэ. Үсэглэл нь датаны утгатайгаа яг таарч байх шаардлагатайг анхаар. Хэрэв датанд байхгүй түвшин үүсгэх бол [`fct_expand()` instead](#fct_add))-ыг хэрэглэ.  

```{r}
linelist <- linelist %>%
  mutate(delay_cat = fct_relevel(delay_cat, "<2 days", "2-5 days", ">5 days"))
```

Бид одоо түвшингүүд коммандад зааж өгсний дагуу илүү ойлгомжтой эрэмбэлэгдсэн байгааг харж байна.

```{r}
levels(linelist$delay_cat)
```

График дээр хэвлэгдэх дараалал ч гэсэн илүү ойлгомжтой болж байна.  

```{r, warning=F, message=F}
ggplot(data = linelist)+
  geom_bar(mapping = aes(x = delay_cat))
```


## Түвшин нэмэх, хасах 

### Нэмэх {#fct_add .unnumbered}
Хэрэв үүсгэсэн фактортоо дахин түвшин нэмэх бол`fct_expand()`-ийг хэрэглэ. Баганын нэрийг нэмж буй түвшинтэй нь (таслалаар тусгаарлаж) бичихэд болно. Утгыг хүснэгтэнд өрж харвал шинэ түвшин 0 удаа давтамжтай буйг харж болно. **base** R-ын `table()` эсвэл **janitor**-ын `tabyl()` -аар хүснэгт болгож харна уу :  

```{r}
linelist %>% 
  mutate(delay_cat = fct_expand(delay_cat, "Not admitted to hospital", "Transfer to other jurisdiction")) %>% 
  tabyl(delay_cat)   # хүснэгт хэвлэ
```


Тэмдэглэл: Дутуу утгыг (`NA`) хялбар аргаар түвшин болгож нэмдэг тусгай функц **forcats** -д буй.[Missing values](#fct_missing) хэсгийг нэмж үзнэ үү.  


### Хасах {.unnumbered}  

`fct_drop()`-ийг хэрэглэвэл "ашиглагдаагүй", 0 давтамжтай түвшин хасагдах болно.  Өмнөх жишээний нэг түвшин ("эмнэлэгт хэвтээгүй тохиолдлууд") түвшин гэж гарч буй боловч 0 давтамжтай байсан. Энэ үед фактортай баганаа `fct_drop()`-д оруулж уншуулбал энэхүү 0 давтамжтай түвшин хасагдна:  

```{r}
linelist %>% 
  mutate(delay_cat = fct_drop(delay_cat)) %>% 
  tabyl(delay_cat)
```




## Түвшний эрэмбийг тохируулах {#fct_adjust} 

**forcats** -багцын функцуудээр факторын түвшний эрэмбийг хялбар аргаар тохируулж болно (багана фактор хэлбэрт хувирсан байх шаардлагатай): 

Эдгээр функцууд фактор баганад хоёр янзаар үйлчилнэ:  

1) Хүснэгтийн багана:, өөрчлөлт датанд хийгдсэн тул датанд цаашид хийгдэх үйлдэлд нөлөөлнө.  
2) *График дотор*: Ингэснээр өөрчлөлт зөвхөн график дотор хийгдэх болно.  



### Гараар гүйцэтгэх {.unnumbered} 

Энэхүү функц факторын түвшний эрэмбийг гараар янзалдаг. Хэрэв фактор биш баганад хэрэглэвэл тухайн багана эхлээд фактор хэлбэрт хувирдаг.  

Эхлээд хаалтан дотор баганын нэрийг оруулаад араас нь дараахь хоёрын аль нэгийг оруул:  

* Бүх түвшнийг хүссэн дарааллаар нь жагсааж бич (карактер вектор хэлбэрээр `c()`) эсвэл  
* Засах нэг ширхэг түвшин болон түүний шинэ эрэмбийн дугаарыг `after = ` аргументэд бичнэ.  

Энэхүү жишээнд `delay_cat` баганын түвний эрэмбийг дахин зааж өгч (өмнө нь фактор байсан) хүссэн дарааллалдаа хэрхэн оруулахыг харуулав. 

```{r}
# түвшний эрэмбийг дахин зааж өгч
linelist <- linelist %>% 
  mutate(delay_cat = fct_relevel(delay_cat, c("<2 days", "2-5 days", ">5 days")))
```

Зөвхөн нэг л түвшинг зөөх шаардлагатй үед `fct_relevel()` -ыг дангаар нь хэрэглэж,  засагдах эрэмбийн дугаарыг `after = ` аргументэд зааж өг. Жишээ нь дараахь коммандаар "<2 days" гэсэн түвшин хоёрдугаар байрлалруу зөөгдөж байна: 

```{r, eval=F}
# түвшний эрэмбийг дахин зааж өгч
linelist %>% 
  mutate(delay_cat = fct_relevel(delay_cat, "<2 days", after = 1)) %>% 
  tabyl(delay_cat)
```




### График дотор {.unnumbered}  

Хүснэгтээс гадна график доторх түвшний эрэмбийг **forcats** -аар зааж өгч болно. График байгуулдаг `ggplot()` функц дотор баганын нэрийг эдгээр функцэд оруулснаар түвшнийг эрэмбэлж, эргүүлж болно. Ингэхэд зөвхөн графикт л өөрчлөлт орно. 

Доор жишээнд хоёр графикийг`ggplot()` -ээр байгуулав ( [ggplot basics] хуудсаас лавлаж болно). Эхний графикт `delay_cat` баганыг x-тэнхлэгт байрлуулж,  түвшний эрэмбэ нь default хэлбэрээр байна. Хоёр дах графикийн кодонд баганын нэрийг `fct_relevel()`-т оруулснаас график дээр эрэмбэ нь өөрчлөгдсөн байна. 

```{r, echo =F}
linelist <- linelist %>% 
  mutate(delay_cat = fct_relevel(delay_cat, c("2-5 days", "<2 days", ">5 days")))

```



```{r, warning=F, message=F, out.width = c('50%', '50%'), fig.show='hold'}
# default эрэбмэ нь цагаан толгойн дарааллаар, багаас ихсэх зарчимтай- ggplot дотор тохируулга хийж өгөөгүй
ggplot(data = linelist)+
    geom_bar(mapping = aes(x = delay_cat))

# факторын түвшний эрэмбийг ggplot дотор тохируулж өгсөн
ggplot(data = linelist)+
  geom_bar(mapping = aes(x = fct_relevel(delay_cat, c("<2 days", "2-5 days", ">5 days"))))
```

Ингэж өөрчлөхөд x тэнхлэгийн default гарчигны байдал ойлгомжгүй болж ирж байна. Энэ гарчигийг **ggplot2**-ын  `labs()` аргументээр дахин шинээр өгч болно. 




### Урвуулах {.unnumbered}  

Түвшний эрэмбийг урвуулан байрлуулах шаардлага их гардаг. Энэ үед факторуудыг `fct_rev()`-т оруулж бичихэд хангалттай.  

Хэрэв *зөвхөн* график дээрх эрэмбийг өөрчлөөд дата доторх факторын эрэмбийг хэвээр үлдээх бол `guides()` функцыг хэрэглэж болно ([ggplot tips] хэсгээс харна уу).  




### Давтамжаар {.unnumbered}  

Датанд харагдах давтамжийн тоогоор эрэмбэлэхдээ `fct_infreq()`-ийг хэрэглэдэг. Дутуу утгуудыг (`NA`) тодорхой түвшин зааж өгөөгүй тохиолдолдавтоматаар хамгийн төгсгөлд эрэмбэлэгддэг ([this section](#fct_missing) -ээс харна уу). Үүнийгээ  `fct_rev()`-т давхар оруулж урвуугаар нь эрэмбэлж болно..  

Энэ функцыг доор үзүүлсэнчлэн `ggplot()`дотор хэрэглэж болно.  

```{r, out.width = c('50%', '50%', '50%'), fig.show='hold', warning=F, message=F}
# давтамжаар нь эрэмбэлэх
ggplot(data = linelist, aes(x = fct_infreq(delay_cat)))+
  geom_bar()+
  labs(x = "Delay onset to admission (days)",
       title = "Ordered by frequency")

# урвуу давтамжаар эрэмбэлэх
ggplot(data = linelist, aes(x = fct_rev(fct_infreq(delay_cat))))+
  geom_bar()+
  labs(x = "Delay onset to admission (days)",
       title = "Reverse of order by frequency")
```


### Харагдах байдлаар {.unnumbered}  

Датанд харагдах байдлаар нь (эхний мөрөөс эхэлж тооцно) эрэбэлэхийн тулд `fct_inorder()`-ийг хэрэглэ. Хэрэв та датагаа эхнээс нь `arrange()`-аар эрэмбэлсний дараа факторт хувиргасан бол энэхүү функцыг хэрэглэхэд тохиромжтой байдаг. 




### Өөр баганын тойм статистикийн тооцооллоор {.unnumbered}  

Сонгосон баганын түвшинг`fct_reorder()`-ыг ашиглаж *өөр баганын тойм  статистикийн тооцооллын* дагуу эрэмбэлж болно. Ингэж эрэмбэлэхэд аажмаар өгсөж, буурсан bars/цэгүүд үүсч ойлгомжтой, харахад үзэмжтэй болдог. 

Жишээнд x  тэнхлэгт `delay_cat` багана  y тэнхлэгт  `ct_blood` гэсэн тоон багана байрлуулсан байна (босго утга). Box plot CT -ын утгыг `delay_cat` -ын бүлэг тус бүрээр харуулсан байна. Бид үүнийг CT утгын медианы дүнгийн өгссөн дарааллаар эрэмбэлэгдсэн box plots болгож хувиргахыг зорьсон болно.

Эхний график нь цагаан толгойн дарааллаа, багаас ихсэх тоон дарааллаар (alpha-numeric) түвшин эрэмбэлэгдсэн.  Тиймээс box plot -ын өндөр нь янз бүрээр холилдож, тодорхой дараалалгүй харагдаж байна. Хоёрдах жишээнд  `delay_cat` баганыг  (x-тэнхлэгдэх)  `fct_reorder()` дотор оруулж, `ct_blood` баганыг араас нь хоёр дах аргументээр зааж өгч, "median" -ийг гуравдах аргументээр өгсөн байна (мөн "max", "mean", "min" зэргийг хэрэглэж бас болно). Ингэснээр `delay_cat` -ын түвшний эрэмбэ нь CT баганын медианы өгсөх will now reflect ascending median CT values of each `delay_cat` group's median CT value. Энэ нь хоёр дах график дээр харагдаж байна. Box plot -ууд  дахин өсөх дарааллаар эрэмбэлэгдсэн байна. Хэрэв `NA` -г тодорхой түвшинд хуваарилахгүй бол (дутуу утга) автоматаар хамгийн сүүлд байрладаг болохыг анхаана уу.  

```{r, fig.show='hold', message=FALSE, warning=FALSE, out.width=c('50%', '50%')}
# анхны факторын түвшнээр эрэмбэлэгдсэн boxplots 
ggplot(data = linelist)+
  geom_boxplot(
    aes(x = delay_cat,
        y = ct_blood, 
        fill = delay_cat))+
  labs(x = "Delay onset to admission (days)",
       title = "Ordered by original alpha-numeric levels")+
  theme_classic()+
  theme(legend.position = "none")


# CT баганын  median утгаар эрэмбэлэгдсэн boxplots
ggplot(data = linelist)+
  geom_boxplot(
    aes(x = fct_reorder(delay_cat, ct_blood, "median"),
        y = ct_blood,
        fill = delay_cat))+
  labs(x = "Delay onset to admission (days)",
       title = "Ordered by median CT value in group")+
  theme_classic()+
  theme(legend.position = "none")
```

Энэ үйлдлийг хийхэд `ggplot()` коммандын өмнө ямар нэгэн нэмэлт үйлдлэл хийгдэх шаардлагагүй гэдгийн анхаарна уу. Бүлэглэж, тооцоолол хийх бүх үйлдэл ggplot комманд дотроо хийгдэж байна. 


### "Сүүлийн" утгаар {.unnumbered}  

Бүлэглэсэн шугаман графикт `fct_reorder2()` -ыг хэрэглэн. График дах шугамын "төгсгөлийн" хэсгийн түвшингүүдийг (мөн *легенд*) босоо тэнхлэгийн дагуу эрэмбэлдэг. Өөрөөр хэлбэл x тэнхлэг дэх утгын хамгийн ихтэй хамааралтай y утгыг эрэмбэлнэ гэсэн үг.

Жишээ нь эмнэлэг тус бүрийн өвчлөлийн бодит тоог цаг хугацаагаар харуулсан график байгуулах шаардлагатай үед `fct_reorder2()`-ыг `aes()` доторх `color = ` аргументэд дээр хэрэглэвэл графикийн төгсгөлийн шугамуудын босоо тэнхлэг дагуу эрэмбэ нь легендэд заасан эмнэлэгүүдийн босоо тэнхлэг дагуу эрэмбэтэй ижил харагдах болно. Энэ талаар [online documentation](https://forcats.tidyverse.org/reference/fct_reorder.html) материалаас уншна уу.  

```{r, warning=F, message=F}
epidemic_data <- linelist %>%         # linelist-ээр эхэд
    filter(date_onset < as.Date("2014-09-21")) %>%    # харахад ойлгомжтой болгох зорилготой босго огноо 
    count(                                            # долоо хоног тутам, эмнэлэгүүддэх бүрээр харуулах
      epiweek = lubridate::floor_date(date_onset, "week"),  
      hospital                                            
    ) 
  
ggplot(data = epidemic_data)+                       # график байгуулж эхлэх
  geom_line(                                        # шугам хийх
    aes(
      x = epiweek,                                  # тархварзшйн дотоо хоногийн х тэнхлэг
      y = n,                                        # өндрөөр долоо хоног тутам дах бодит тоог илэрхийлнэ
      color = fct_reorder2(hospital, epiweek, n)))+ # эмнэлэг тус бүрээр датаг бүлэглэж өнгөөр ялгана. Графикийн төгсгөлийн тооны эрэмбээр факторын эрэмбийг тодорхойлно
  labs(title = "Factor levels (and legend display) by line height at end of plot",
       color = "Hospital")                          # легендийн гарчигийг өөрчлөх
```




## Дутуу утга {#fct_missing}  

Танай үүсгэсэн фактор багана `NA` дутуу утга агуулж буй бол `fct_explicit_na()` ашиглаж хялбархан факторын түвшин болгож "Missing" зэргээр нэрлэж болно. "(Missing)" болж хувирсан бүх түвшингүүдийн Default-аар хамгийн ард орж эрэмбэлэгддэг. Нэрийг нь  `na_level = ` аргументээр өөрчилж болно.  

Дээрх үйлдлийг `delay_cat` дээр туршиж үзэж, `tabyl()` -аар хүснэгтлэн хэвлэж үзэхэд `NA`-г "Missing delay" болж өөрчлөгдсөн байна.

```{r}
linelist %>% 
  mutate(delay_cat = fct_explicit_na(delay_cat, na_level = "Missing delay")) %>% 
  tabyl(delay_cat)
```





## Түвшнүүдийг нэгтгэх  


### Гар аргаар {.unnumbered}  

Түвшний харагдах  `fct_recode()`-г ашиглаж гараар янзалж болно. Энэ нь **dplyr** -ын `recode()` функцтэй адил ([Cleaning data and core functions]-ээс хар) боловч`fct_recode()` -иг хэрэглэснээр шинээр фактор түвшингүүд үүсгэх боломжтой болдгоороо онцлог . Ердийн `recode()`-ийг хэрэглэсэн үед шинэ утгыг хүлээн авах боломжтой гэж тохируулахаас наас хүлээж авдгүй. 

Энэхүү функцээр дахин утга оруулахдаа олон түвшинд ижил утга оруулж түвшнүүдийг "нэгтгэж" болно. Ингэхдээ хэрэгтэй мэдээллээ санамсаргүй утгагдхаас болгоомлоорой! Нэгтгэх үйлдлээ шинэ багана үүсгэх хийхийг зөвлөж байна (хуучих багана дээрээс бичигдэхгүй, мэдээлэл алдагдахгүй байх болно).  

`fct_recode()` нь `recode()`-ээс өөр синтакстй. `recode()` -ээр`ХУУЧИН = ШИНЭ`гэсэн дараалалтай байхад `fct_recode()` нь `ШИНЭ = ХУУЧИН` гэсэн дараалалтай.     

Эхлээд `delay_cat` -ын түвшин дараа байдалтай байна:  
```{r, echo=F}
linelist <- linelist %>% 
  mutate(delay_cat = fct_relevel(delay_cat, "<2 days", after = 0))
```


```{r}
levels(linelist$delay_cat)
```

Шинэ түвшинг `fct_recode(column, "new" = "old", "new" = "old", "new" = "old")` гэсэн синтаксаар үүсгэж хэвлэв:  

```{r}
linelist %>% 
  mutate(delay_cat = fct_recode(
    delay_cat,
    "Less than 2 days" = "<2 days",
    "2 to 5 days"      = "2-5 days",
    "More than 5 days" = ">5 days")) %>% 
  tabyl(delay_cat)
```

Энд эдгээр түвшнийг `fct_recode()`ашиглаж нэтгэв. "Less than 5 days" гэсэн түвшин шинээр үүсгэхэд алдаа гарч анхааруулсан байгааг ажиглаарай.  


```{r, warning=F, message=F}
linelist %>% 
  mutate(delay_cat = fct_recode(
    delay_cat,
    "Less than 5 days" = "<2 days",
    "Less than 5 days" = "2-5 days",
    "More than 5 days" = ">5 days")) %>% 
  tabyl(delay_cat)
```





### "Бусад" болгож хумих {.unnumbered}  

Гараар "Бусад" гэсэн түвшин үүсгэх бол `fct_other()`гэсэн функцыг хэрэглэж болно. Дор жишээнд `hospital` баганын "Port Hospital" болон "Central Hospital" түвшингээс бусад нь "Other" түвшинд нэтггэдсэн байна. Энэ үед `keep = ` эсвэл `drop = `-ээр вектор оруулж хасаж, нэмэх утгаа зааж өгч болно. "Бусад" гэсэн түвшний харагдах байдлыг `other_level = `гэсэн аргументээр өөрчилж болно.  

```{r}
linelist %>%    
  mutate(hospital = fct_other(                      # түвшнүүдийг тохируул
    hospital,
    keep = c("Port Hospital", "Central Hospital"),  # салангид байлга
    other_level = "Other Hospital")) %>%            # Бусад бүх утгыг "Other Hospital" болго
  tabyl(hospital)                                   # хүснэгтийг хэвлэ

```




### Давтамжаар нь хумих {.unnumbered}

Хамгийн бага давтамжтай түвшнүүдийг `fct_lump()`-ээр нэгтгэж болдог.  

Бага давтамжтай бүлгүүдийг олноор нь "овоолж" нэгтгэн "Other" түвшин үүсгэхийн тулд дараах үйлдлүүдээс сонгож хийнэ үү:  

* `n = ` -ээр хэдэн бүлэг үүсгэхээ зааж өгнө. Ингэснээр хамгийн их давтамжтай n бүлэг үлдэж, үлдсэн хэсэг нь "Other" гэсэн бүлэгт нэтгэгднэ
.  
* Set `prop = ` үлдээх гэж буй түвшний давтамжид босго хувь зааж өгснөөр. Энэхүү босго хувиас бага утгууд "Other" болж нэгтгэгднэ.

"Other" түвшний харагдах байдлыг `other_level = ` аргументээр тохируулж өөрчилж болно. Доорх жишээнд хамгийн их давтамжтай хоёр эмнэлэгээс бусад нь "Other Hospital" болж нэтгэгдсэн.

```{r, warning=F, message=F}
linelist %>%    
  mutate(hospital = fct_lump(                      # түвшнүүдийг тохируул
    hospital,
    n = 2,                                          # дээд талын хоёр түвшинг үлдээ
    other_level = "Other Hospital")) %>%            # бусдыг нь "Other Hospital"-т нэгтгэ
  tabyl(hospital)                                   # хүснэгтийг хэвлэ

```




, warn
## Бүх түвшнийг харуул  

Фактор хэрэглэхийн бас нэг ач холбогдол бол датанд ямар утга байгаагаас үл хамааран графикийн легенд болон хүснэгт жигдэрч өгөх явдал юм. 

Хэрэв олон график, зураг зэрэг бэлдэж буй үед (графикийг газар нутгаар нь ялгаж харуулах гэх мэт) легенд, хүснэгтийг яг адилхан байлгах шаардлагатй болдог (датанд өөрөөр бичигдсэн байсан ч гэсэн).  

### Графикт {.unnumbered}  

`ggplot()`-ын дотор тохирох `scale_xxxx()` функц дотор `drop = FALSE` гэсэн аргумент нэмж болно. Ингэснээр факторын бүх түвшин датанд байхгүй ч гэсэн графикт гарч ирдэг. Хэрэв фактор баганын чинь түвшингүүд `fill = ` аргументэд ашиглагдаж байгаа бол scale_fill_discrete() дтор `drop = FALSE` гэж өгнө (доор харуулсан). Хэрэв түвшингүүдийг `x = `(x-тэнхлэг) ,`color = `, `size = `-д оруулсан бол `drop = FALSE`-ыг `scale_color_discrete()` эсвэл `scale_size_discrete()` -д оруулна.  

Жишээнд насны ангиллыг эмнэлэг тус бүрээр давхарласан bar plot -д оруулж харуулсан. Үүн дээр `scale_fill_discrete(drop = FALSE)` гэж нэмж өгснөөр легендэд бүх насны бүлэг харагдах болно (датанд байхгүй ч гэсэн).

```{r}
ggplot(data = linelist)+
  geom_bar(mapping = aes(x = hospital, fill = age_cat)) +
  scale_fill_discrete(drop = FALSE)+                        # датанд байгаагүй ч гэсэн легенд дээр бүх насны ангилал харагдна
  labs(
    title = "All age groups will appear in legend, even if not present in data")
```

### Хүснэгтэнд {.unnumbered}  

**base** R-ын `table()`болон **janitor**-ын `tabyl()` -ыг алийг нь ч хэрэглэсэн бүх фактор түвшинг харуулна (хэрэглэгдээгүй түвшин ч гэсэн).  

хэрэв хүснэгтийг **dplyr**-ын `count()` эсвэл `summarise()`-ээр байгуулж буй бол `.drop = FALSE` гэсэн аргумент нэмж хэрэглэгдээгүй ч гэсэн бүх фактор түвшинг гарч ирэх болно.

[Descriptive tables] хуудас эсвэл [scale_discrete documentation](https://ggplot2.tidyverse.org/reference/scale_discrete.html), or the [count() documentation](https://dplyr.tidyverse.org/reference/count.html) линкээс нэмж уншна уу. [Contact tracing] хуудасны жишээг нэмж үзэж болно.  


## Тархвар зүйн долоо хоног  

Тархварзүйн долоо хоногийг хэрхэн байгуулах талаар дэлгэрэнгүй бичсэнийг [Grouping data] хуудаснаас нэмж үзнэ үү. 
Мөн [Working with dates] хуудасны тархварзүйн долоо хоногийг үүсгэж, хэлбэржүүлэх талаар үзнэ үү.


### График дээрх тархварзүйн долоо хоног  {.unnumbered}  

Тархварзүйн долоо хоногийг графикт буулгаж харуулахын тулд **lubridate**-ын `floor_date()` функцыг [Grouping data] хуудаст тайлбарласны дагуу ашиглаж болно. Ингэснээр огноо төрлийн  YYYY-MM-DD гэсэн хэлбэртэй утга үүсдэг. Ингэж үүсгэсэн огноо баганыг графикт буулгавал эрэмбэ нь автоматаар зөв гарч ирдэг ба факторт хувиргаж, түвшнийг эрэмбэлэх шаардлагагүй юм. Доор жишээний өвчин эхлэл огноог `ggplot()` гистограммаар харуулсныг үзнэ үү.  

Огнооны харагдах байдлыг `scale_x_date()` -ээр тохируулж болно. Энэ талаар [Epidemic curves] хуудаснаас нэмж үзнэ үү. `scale_x_date()`функцын `date_labels = ` аргументэд "strptime" форматыг зааж өгч болно. Энэхүү формат "%" -ыг тэмдэгтийг хэрэглэдэг ба дэлгэрэнгүй мэдээллийг [Working with dates] хуудаст оруулсан. Тухайлбал "%Y" гэж бичвэл жилийг 4 цифрээр бичихийг заадаг бо "%W" эсвэл "%U" -аар хэддүгээр долоо хоног болохыг зааж өгдөг (нэгдэх эсвэл бүтэнсайнаар эхэлдэг долоо хоног).  

```{r, warning=F, message=F}
linelist %>% 
  mutate(epiweek_date = floor_date(date_onset, "week")) %>%  # долоо хоногийн багана
  ggplot()+                                                  # ggplot-ыг эхэл
  geom_histogram(mapping = aes(x = epiweek_date))+           # өвчний эхлэлийн гистограмм
  scale_x_date(date_labels = "%Y-W%W")                       # огнооны формат YYYY-WWw гэж байна
```


### Датандах тархварзүйн долоо хоног  {.unnumbered}  

Хэрэв таны гол зорилго график бүтээх *биш* бол дараах хоёр аргыг хэрэглэж болох юм:

1) *For fine control over the display*, convert the **lubridate** epiweek column (YYYY-MM-DD) to the desired display format (YYYY-WWw) *within the data frame itself*, and then convert it to class Factor.  

Эхлээд **base** R -ын `format()` -аар огнооны YYYY-MM-DD форматыг YYYY-Www болгож хувирга ([Working with dates] хуудсаас харна уу). Ингэснээр карактер төрлийн багана болж хувирна. Үүнийг `factor()`-аар фактор төрөлруу хувиргана..  


```{r}
linelist <- linelist %>% 
  mutate(epiweek_date = floor_date(date_onset, "week"),       # тархварзүйн долоо хоног үүсгэ (YYYY-MM-DD)
         epiweek_formatted = format(epiweek_date, "%Y-W%W"),  # Хувирга (YYYY-WWw)
         epiweek_formatted = factor(epiweek_formatted))       # Факторт хувирга

# Түвшнүүдийг харуул
levels(linelist$epiweek_formatted)
```

<span style="color: red;">**_АЮУЛ:_** Хэрэв та долоо хоногийн дугаарыг жилийн урд талд оруулбал  ("Www-YYYY") ("%W-%Y") default тохируулга болон цагаан толгойн дараалал, багаас их тооруу чиглэсэн дарааллаар буруу эрэмбэлэгднэ (01-2015 нь 35-2014 урд талд гарах зэргээр). Үүнээс болж гараар эрэмбийг янзлах шаардлага үүсдэг ба энэ нь маш их ажиллагаатай хийгддэг.</span>  

2) *For fast default display*, use the **aweek** package and it's function `date2week()`. Долоо хоногийн эхлэх өдрийг `week_start = ` аргументээр тохируулж болох ба хэрэв `factor = TRUE` гэж тохируулбал үүсэх багана нь фактор байх болно. Мөн факторын түвшин нь байж болох *бүх* долоо хоногийг оруулдаг (тухайн долоо хоногт тохиолдол гараагүй байсан ч гэсэн ).
```{r, eval=F}
df <- linelist %>% 
  mutate(epiweek = date2week(date_onset, week_start = "Monday", factor = TRUE))

levels(df$epiweek)
```

[Working with dates] хуудаснаас  **aweek**-ийн талаар нэмж үзэж болно. Энэ багцад бас урвуу функц `week2date()` байдаг.  



<!-- ======================================================= -->
## Эх сурвалж {} 

R for Data Science номын  [factors](https://r4ds.had.co.nz/factors.html) хуудас 
[aweek package vignette](https://cran.r-project.org/web/packages/aweek/vignettes/introduction.html).
