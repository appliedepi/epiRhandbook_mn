
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# Датаг пивот хийх  {}

```{r, warning=F, message=F, out.height = c('50%'), fig.align="center", fig.show='hold', echo=F}
knitr::include_graphics(here::here("images", "pivoting", "Pivoting_500x500.png"))

#knitr::include_graphics(here::here("images", "pivoting", "pivot_longer_new.png"))
#knitr::include_graphics(here::here("images", "pivoting", "pivot_bar.png"))
#knitr::include_graphics(here::here("images", "pivoting", "pivot_wider_new.png"))
```



Дата менежментийн үед *пивот*-ыг дараах хоёр тохиолдолд хэрэглэдэг:  

1. *Пивот хүснэгт*-ийг байгуулахад хэрэглэнэ. Пивот гэдэг нь датаны статистик үзүүлэлтүүдийг хүснэгтэлж, дүгнэж харуулахыг хэлдэг.
2. Дата хүснэгтийг **урт** -аас **өргөн** эсвэл **өргөн** -өөс **урт** формат болгож хувиргахад хэрэглэнэ.

**Энэхүү хуудаст хоёрдугаар хэрэглээг голчилж үзэх болно.** Эхний хэрэглээ нь дата анализийн маш чухал хэсэг тул [Grouping data] болон [Descriptive tables] хуудсуудад дэлгэрэнгүйгээр тайлбарлагдна. 
 

Энэ хуудсанд ихэвчлэн датаны форматыг янзлах талаар үзэх болно. "Цэгцтэй дата" буюу хувьсагч болгон өөрийн баганатай, ажиглалт бүр өөрийн мөртэй, утга бүр өөрийн гэсэн нүдэнд оршдог талаар санаж байх хэрэгтэй.Энэ талаар илүү дэлгэрэнгүйгээр  [at this online chapter in R for Data Science](https://r4ds.had.co.nz/tidy-data.html) -д тайлбарласан байдаг. 




## Бэлтгэл   

### Багцуудыг ачааллах  {.unnumbered}  

Энэ хэсэгт анализ хийхэд шаардлагатай багцуудыг доорхи кодоор ачааллана.**pacman** багцын `p_load()` функцээр шаардлагатай багцыг татаж аваад ачааллана уу. Өмнө татаж авсан багцуудаа **base** R -ын `library()`-аар ачааллаж болно. Багцын талаарх нэмэлт мэдээллийг [R basics] хэсгээс харна уу.  

```{r}
pacman::p_load(
  rio,          # Файлыг импортлох
  here,         # Файлыг байрлуулах
  tidyverse)    # дата менежмент + ggplot2 графикууд
```



### Датаг импортлох  {.unnumbered}


### Хумхаагийн бодит тоон дата  {-}  

Энэ хуудасны жишээ дасгалд хумхаагийн өдөр тутмын тохиоллдолтой зохиомол датаг ашиглах болно. Дагаж дасгалыг ажиллах бол <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/malaria_facility_count_data.rds' class='download-button'>линк дээр дарж татаж авна уу (as .rds file)<span></a>. Датагаа  **rio** багцын `import()` функцээр импортло (энэ функц .xlsx, .csv, .rds зэрэг олон өргөтгөлтэй ажиллаж чаддаг [Import and export] хуудаст нэмж тайлбарласан).  

```{r, echo=F}
count_data <- rio::import(here::here("data", "malaria_facility_count_data.rds")) %>% 
  as_tibble()
```

```{r, eval=F}
# Дата импортлох
count_data <- import("malaria_facility_count_data.rds")
```

Эхний 50 мөрийг дор хэвлэж харуулав.

```{r, message=FALSE, echo=F}
# linelist датаг хүснэгт хэлбэрээр харуул
DT::datatable(head(count_data, 50), rownames = FALSE, options = list(pageLength = 5, scrollX=T), class = 'white-space: nowrap' )
```


### Linelist бодит тоон дата  {-}  

Энэ хуудасны сүүлийн хэсэгт Эболагийн дэгдэлтийн зохиомол датаг ашиглах болно. Дагаж дасгалыг ажиллах бол  <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds' class='download-button'>линкинй "clean" linelist дээр дарж татаж авна уу</a> (as .rds file). Датагаа  **rio** багцын `import()` функцээр импортло (энэ функц .xlsx, .csv, .rds зэрэг олон өргөтгөлтэй ажиллаж чаддаг [Import and export] хуудаст нэмж тайлбарласан).  

```{r, echo=F}
# linelist -ийг R -т импортло
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))
```


```{r, eval=F}
# Датасетээ импортло
linelist <- import("linelist_cleaned.xlsx")
```







<!-- ======================================================= -->
## Өргөнөөс уртруу хувиргах  {}

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "pivoting", "pivot_longer_new.png"))
```


<!-- ======================================================= -->
### "Өргөн" формат  {.unnumbered}

Ихэнх дата "өргөн" форматтай байдаг. Өргөн формат гэдэг нь тухайн субьекттэ хамаатай хэв шинж, хариултууд бүгд нэг мөрөнд хадгадагдсан байхыг хэлнэ. Ингэж харуулах нь ойгомжтой боловч анализ хийхэд тохиромжгүй байдаг.  

Өмнөх Бэлтгэл хэсэгт импортлож оруулсан `count_data` датаг авч үзье. Датаг харахад мөр болгон байгууллага тус бүрийн өдөр тутмын байдлыг ( "facility-day")-г харуулж байна. Яг жинхэнэ тохиолдлын тоо (хамгийн баруун талын багана) нь "өргөн" форматаар хадгалагдаж нас насан дах тохиолдлын тоо нь дан мөрөнд хадгалагдсан байна. 

```{r, echo=F}
DT::datatable(count_data, rownames = FALSE, options = list(pageLength = 5, scrollX=T) )
```

Энэхүү датасетийн ажиглалт бүр эдгээр 65 байгууллагын нэгэнд тухайн өдөр гарсан хумхаагийн тоог илтгэж байна. Огноо нь ranging ` count_data$data_date %>% min()` -ээс ` count_data$data_date %>% max()` хүртэл үргэлжилнэ. Эдгээр байгууллагууд Хойд `Аймаг`-ын  (Spring, Bolo, Dingo, Barnard) гэсэн дөрвөн `Дүүрэгт` тарж байрласан. Энэхүү дата хумхаагийн тоог нийт болон гурван насны ангиллаар (<4 нас, 5-14 нас, 15 -аас дээр нас) тус бүр харуулсан. 

Иим "Өргөн" хэлбэрийн формат нь  "цэгцтэй дата" байж чаддаггүй.  Учир нь энэхүү баганын толгойнууд "хувьсагчийг" биш харин "насны бүлэглэл" хэмээх хувьсагийн *утгыг* илтгэж байдаг.

Энэ формат нь мэдээллийг хүснэгтээр үзүүлэх эсвэл тохиолдлын тоотой тайлангийн маягтаас өгөгдөл оруулахад (жишээ нь Excel дээр) хэрэгтэй байж болно. Харин анализ хийхийн өмнө энэ датаг "урт" фомартруу шилжүүлж "цэгцтэй дата" -ны стандартад нийцүүлэх хэрэгтэй байдаг. R -ын график байгуулдаг **ggplot2** багц "урт" форматтай дататай илүү зохицдог.  

Одоогийн форматад хумхаагийн *нийт* тоог цаг хугацааны хувьд тооцоход асуудалгүй:

```{r, warning=F, message=F}
ggplot(count_data) +
  geom_col(aes(x = data_date, y = malaria_tot), width = 1)
```

Харин энэхүү нийт тохиолдлын тоонд насны ангилал хэрхэн нөлөөлж буйг хэрхэн тооцоолж харуулах вэ? Үүний тулд сонирхож буй хувьсагч болох (насны ангилал)-ыг датанд нэг баганад оруулах хэрэгтэй ба ингэснээр `{ggplot2}`-ын "mapping aesthetics" `aes()` аргументэд өгөгдөл болж орох боломжтой болно.



<!-- ======================================================= -->
### `pivot_longer()` {.unnumbered}

Датаг **tidyr** багцын `pivot_longer()` функцээр "урт" болгож болно. **tidyr** нь **tidyverse** -ын харьяа багцуудын нэг.  

Энэхүү функцээр хэсэг багануудыг зэрэг өгөгдлөөр (`cols = ` аргументэд) оруулж, хувиргах боломжтой. Тиймээс энэ нь датаны зөвхөн тодорхой хэсэгт үйлчилдэг. Энэ онцлог нь хумхаагийн датаг хувиргахад их тохиромэтой. Учир нь бид зөвхөн тохиолдлын тоотой багануудыг л хувиргах шаардлагтай. 

Энэхүү процессийн эцэст хоёр төрлийн багануудтай болдог. Үүний нэг нь шинээр үүссэн ангиллын нэрийг бичсэн (энэ ангиллууд хуучин хүснэгтийн баганын нэр байсан) багана, нөгөө нь эдгээр ангилалд тохирох утгууд (тохиолдлын тоо)-тай багана юм. Шинээр үүссэн хоёр баганын автоматаар үүссэн нэрийг хэрэглэж болно. Эсвэл `names_to = ` болон `values_to = ` аргументуудэд тусгай нэр өгч автомат нэрийг өөрчилж болно. 

`pivot_longer()` -ийг хэрхэн ашиглахыг харцгаая... 



### Стандарт пивот {.unnumbered}  

**tidyr** багцын `pivot_longer()` функцээр "өргөн" датаг "урт" формат болгох болно. Ялангуяа хумхаагийн тоог харуулсан дөрвөн тоон баганыг *насны ангиллууд*-ыг агуулсан нэг багана, үүнд тохирсон тоон үзүүлэлттэй утгыг агуулсан өөр нэг багана болгож хувиргах хэрэгэтэй.  

```{r, eval=F}
df_long <- count_data %>% 
  pivot_longer(
    cols = c(`malaria_rdt_0-4`, `malaria_rdt_5-14`, `malaria_rdt_15`, `malaria_tot`)
  )

df_long
```

Шинээр үүссэн хүснэгтийн (`df_long`) мөрийн тоо илүү  байгааг анхаар (12,152 -г 3,038 тэй харьцуул); Хүснэгт *урт* болсон. Өөрөөр хэлбэл яг дөрөв дахин урт болсон гэсэн үг. Учир нь хуучин хүснэгтийн нэг мөр  df_long хүснэгтийн дөрвөн мөр болж өөрчлөгдсөн ба хумхаагийн дөрвөн төрлийн (<4 нас, 5-14 нас, 15y+, нийт) тоон үзүүлэлт тус бүрт нэг мөр үүссэн гэсэн үг юм .

Шинэ хүснэгт урт болохоос гадна цөөн баганатай (8 -г 10-тэй харьцуулах) болсон байна. Учир нь өмнөх дөрвөн багана дах мэдээлэл ( `malaria_` гэж эхэлсэн баганууд) хоёр баганад хадгалагдах болсон. 

Эдгээр дөрвөн багана `malaria_`гэж эхэлж буй тул "tidyselect"-ын `starts_with()` функцыг ашиглаж хувиргалтаа хийж бас болно (эдгээр туслах функцуудын талаар[Cleaning data and core functions] хэсэгт дэлгэрэнгүй оруулсан).  

```{r}
# tidyselect-ын туслах функцуудээр өөрчлөх хүснэгтийг сонго
count_data %>% 
  pivot_longer(
    cols = starts_with("malaria_")
  )
```

эсвэл байрлалаар нь сонго: 

```{r, eval=F}
# байрлалаар нь сонго
count_data %>% 
  pivot_longer(
    cols = 6:9
  )
```

эсвэл хэсэг дараалласан багануудыг сонго:

```{r, eval=F}
# нэг хэсэг дарааллаасан багануудыг сонгох
count_data %>% 
  pivot_longer(
    cols = `malaria_rdt_0-4`:malaria_tot
  )
```



Энэхүү шинээр үүсэх хоёр баганууд `name` болон `value` гэж автоматаар нэрлэгддэг боловч доторх утгыг ойлгомжтой болгох үүднээс `names_to` болон `values_to` аргументүүдэд илүү тодорхой нэр өгч болно. Жишээ болгож `age_group` болон `counts` гэсэн нэр өгье:

```{r}
df_long <- 
  count_data %>% 
  pivot_longer(
    cols = starts_with("malaria_"),
    names_to = "age_group",
    values_to = "counts"
  )

df_long
```

Шинээр үүсгэсэн датагаа `{ggplot2}`-д оруулж шинэ үүссэн `count` баганыг y-тэнхлэгт байрлуулж, шинэ үүссэн `age_group` баганыг `fill = ` аргументэд (өнгөөр ялгана) өгч болох боломжтой боллоо. Ингэснээр bar графикт хумхаагийн тохиолдлын тоо насны бүлгүүдээр даврхаласан байдлаар харуулсна.

```{r, warning=F, message=F}
ggplot(data = df_long) +
  geom_col(
    mapping = aes(x = data_date, y = counts, fill = age_group),
    width = 1
  )
```

Дараахь шинэ графикийг өмнөх графиктай харьцуулж *буруу хийгдсэн зүйлсийг?* тодруулцгаая.  

Тандалтын датаг янзалж байхад нийтлэг тохиолддог бэрхшээлтэй бид учирсан байна. Мөн `malaria_tot` баганын нийт тоог оруулснаас bar -ын өндөр байх ёстой хэмжээнээс хоёр дахин өндөр болж харагдаж байна. 

Үүнийг хэд хэдэн аргаар шийдвэрлэж болно. Энгийн арга бол `ggplot()`-д оруулахаас өмнө энэхүү нийт (`malaria_tot`)-ийг шүүж хасч болно:

```{r, warning=F, message=F}
df_long %>% 
  filter(age_group != "malaria_tot") %>% 
  ggplot() +
  geom_col(
    aes(x = data_date, y = counts, fill = age_group),
    width = 1
  )
```

Эсвэл `pivot_longer()` коммандыг өгч байхдаа энэ хувьсагчийг хасч болно. Ингэснээр хүснэгтэд тусдаа хувьсагч хэвээр байх болно. Шинэ үүссэн мөрүүд ямар утгууд орж "өргөжсөн" -ийг харна уу.

```{r, warning=F, message=F}
count_data %>% 
  pivot_longer(
    cols = `malaria_rdt_0-4`:malaria_rdt_15,   # нийт тоон үзүүлэлттэй баганыг оруулаагүй
    names_to = "age_group",
    values_to = "counts"
  )
```





### Олон ангилалтай датаг пивот хийх {.unnumbered}


Дээрх жишээний коммандыг "pivot longer" болгож хувиргах баганууд бүгд нэг төрлийн утгатай (карактер, тоон, логик г.м)  байх нөхцөлд илүү тохиромжтой.

Харин талбарын тархвар зүйчээр ажиллаж байхад ихэвчлэн датаг мэргэжлийн бус хүмүүс оруулсан байдгаас стандарт бус логикоор шивэгдсэн олон төрлийн дататай олон учрах болно. Хадлей Викхам **Цэгцтэй датан** -ны зарчмыг [seminal article](https://vita.had.co.nz/papers/tidy-data.pdf) -тайлбарлахдаа Толстойн үгтэй зүйрлэн "Цэгцтэй дата болгон адил ч бүх гэр бүлд байдагчлан замбараагүй дата болгон өөрийн жамаараа замбараагүй байдаг" гэж тайлбарлажээ.

Хамгийн элбэг тохиолддог бэрхшээлүүдийн нэг бол өөр өөр төрлийн дататай багануудыг пивот хийх юм. Ийм датаг пивот хийхэд янз бүрийн дата төрлүүд нэг баганад ордог. Энэ бол сайн арга биш. Энэ үүссэн замбараагүй байдлыг янзлах олон арга буй боловч  `pivot_longer()` -ыг хэрэглэж ийм байдал үүсэхээс та өөрөө сэргийлж болно.

А, В, С гурван зүйл тус бүрийг өөр цаг хугацаануудад хэд хэдэн ажиглалт хийсэн нөхцөл байдлыг авч үзье. Ийм нөхцлүүдээс дурьдвал Эболагийн тохиолдлуудад 21 хоног тутамд ажиглах, эсвэл алслгадсан тосгоны эрүүл мэндийн цэгийн үйл ажиллагааг жилд нэг удаа хянаr зэрэг байж болно. Эхний жишээ дээр ажиллаж үзье. Дата дараах байдлаар хадагалгдсан байв:


```{r, message=FALSE, echo=F}

df <- 
  tibble::tribble(
     ~id,   ~obs1_date, ~obs1_status,   ~obs2_date, ~obs2_status,   ~obs3_date, ~obs3_status,
     "A", "2021-04-23",    "Healthy", "2021-04-24",    "Healthy", "2021-04-25",     "Unwell",
     "B", "2021-04-23",    "Healthy", "2021-04-24",    "Healthy", "2021-04-25",    "Healthy",
     "C", "2021-04-23",    "Missing", "2021-04-24",    "Healthy", "2021-04-25",    "Healthy"
     ) 

DT::datatable(df, rownames = FALSE)

```

Энэ хүснэгт төвөгтэй байдлаар бичигдсэн байна. Мөр болгон нэг зүйлийн талаарх мэдээллийг бичсэн боловч цаг хугацааны дараалал нь хойшоогоо улам л холдоод байна.  Мөн карактер болон огноон баганууд ээлжл орсон байна. 

Зохиогч миний бие өөр нэгэн их хэцүү байдалтай холерийн тандалтын дататай учирч байлаа. Энэ датанд 4 жилийн турш "өдөр бүр" 8 шинэ ажиглалт нэмэгдэж байсан ба компьютер дээрээ  Excel файлыг нь нээх бүрт 10-аас дээш минут зарцуулагддаг байсан!

Ийм байдалтай датанууд ажиллахын тулд "урт" форматруу хувиргах хэрэгтэй боловч ажиглалт тус бүрийн `огноо`, `карактер` (эрүүл мэндийн байдал) багануудын салангид хэвээр байлгах хэрэгэтэй. Тэгж чадахгүй бол олон хувьсагчуудын холимог нэг баганатай болж хоцрох аюултай (цэгцтэй дата болон дата менежментийн хувьд хамгийн болохгүй зүйл):

```{r}
df %>% 
  pivot_longer(
    cols = -id,
    names_to = c("observation")
  )

```

Өмнөх жишээнд пивот маань *огноо* болон *карактерүүд* нэгдэж нэг төрлийн `утга` агуулсан багана болж орсон. Үүнийг R автоматаар карактер багана болгож хувиргах ба агуулагдах датаг хэрэглэх боломжгүй болдог.  


Баганын анхны нэрний синтакс бүтцийг ашиглаж ийм байдлаас сэргийлж болно. Баганыг нэрлэх нийтлэг бүтэц байдаг. Үүнд ажиглалтын дугаар, доогуур зураас, "статус" болон "огноо" араас нь бичигдсэн байдаг.  Энэ синтаксыг ашиглаж пивот хийсний дараа энэ хоёр төрлийн датаг салангид багана хэвээр байлгаж болно. 

Үүнийг хийхдээ:  

* Карактер векторуудыг `names_to = ` аргументэд өгөөд, хоёрдугаарт нь `".value"` гэж оруулна. Энэхүү тусгай тэмдэглэгээ нь пивот хийгдэж буй баганын нэрэн дэх карактер дээр үндэслэж хуваагдах болно гэдгийг зааж өгч буй. 
* Мөн "хуваах" карактерийг `names_sep = ` аргументэд зааж өгнө. Доор жишнээд доогуур зураасыг "_" сонгосон. 

Ингэснээр шинээр үүсэх баганыг нэрлэж, хуваах үйлдэл анхны хувьсагчийн нэрэн дэх доогуур зураасыг тойрч хийгднэ гэсэн үг. 

```{r}

df_long <- 
  df %>% 
  pivot_longer(
    cols = -id,
    names_to = c("observation", ".value"),
    names_sep = "_"
  )

df_long

```

__Сүүлийн засвар__:

`date` багана  *карактер* хэлбэрт байгааг анхаараарай. Үүнийг `mutate()` болон `as_date()` функцуудээр тохирсон огноо хэлбэрийн баганад хувиргахад хялбар ([Working with dates] хуудаст заасны дагуу ).  

Мөн `observation` баганын "obs" гэсэн бичиглэлийг нь хасч `тоон` форматад оруулна.  Үүнийг **stringr** багцын `str_remove_all()` функцээр хийж болно ([Characters and strings] хуудаст тайлбарласан).  

```{r}

df_long <- 
  df_long %>% 
  mutate(
    date = date %>% lubridate::as_date(),
    observation = 
      observation %>% 
      str_remove_all("obs") %>% 
      as.numeric()
  )

df_long

```

Ингээд бид энэхүү дата дээр ажиллаж болохоор боллоо. Жишээ нь дор коммандад heat хавтангаар дескриптив график байгуулж болж байна.

```{r}
ggplot(data = df_long, mapping = aes(x = date, y = id, fill = status)) +
  geom_tile(colour = "black") +
  scale_fill_manual(
    values = 
      c("Healthy" = "lightgreen", 
        "Unwell" = "red", 
        "Missing" = "orange")
  )

```





<!-- ======================================================= -->
## Уртаас өргөнрүү {}

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "pivoting", "pivot_wider_new.png"))
```


Зарим тохиолдолд дата хүснэгтийг өргөн хэлбэрт шилжүүлэх хэрэгцээ гардаг. Энэ үйлдэлд `pivot_wider()` функцыг ашиглаж болно.

Жишээ нь анализийн үр дүнг уншигчдад ойлгомжтой хүснэгтээр харуулах үүднээс хүснэгтийг өргөн хэлбэрт хувиргах хэрэгцээ цөөнгүй гардаг (жишээ нь [Table for presentation][Tables for presentation]). Энэ үед олон мөрүүдэд тархан хадгалагдсан нэг субьектийн мэдээллийг нэг мөрөнд болгож харуулах үйлдэл ихэвчлэн хийгддэг.

### Дата {.unnumbered}

Энэ хэсэгт тохиолдол бүрт нэг мөртэй linelist датаг ашиглана ([Preparation](#pivot_prep) хэсэгт тайлбарласан).

Эхний 50 мөр:  

```{r, message=FALSE, echo=F}
# linelist-ыг хүснэгтээр харуул
DT::datatable(head(linelist, 50), rownames = FALSE, options = list(pageLength = 5, scrollX=T), class = 'white-space: nowrap' )
```


Насны ангилал, хүйсээр нь тохиолдлын тоог харуулахаар бол:

```{r}
df_wide <- 
  linelist %>% 
  count(age_cat, gender)

df_wide
```

Энэхүү хүснэгтээр бид **ggplot2** ашиглаж графикаар датаг харуулахад тохиромжтой боловч хүснэгтээр датаг тайлбарлахад тохирмжгүй болж байна.

```{r}
ggplot(df_wide) +
  geom_col(aes(x = age_cat, y = n, fill = gender))
```

### Өргөн хэлбэрт пивот хийх {.unnumbered}  

Тиймээс `pivot_wider()` -аар датаг хувиргаж, датаг илүү оновчтой байдлаар харуулсан хүснэгтийг тайланд хавсаргах боломжтой юм. 

`names_from` аргументээр *аль* баганыг ашиглаж шинээр үүсэх баганын *нэрсийг* үүсгэхийг зааж өгдөг бол `values_from` аргументээр *ямар* баганын *утгуудыг* авч шинэ нүднүүдэд хуваарилахыг зааж өгдөг. Мөн нэмэлтээр `id_cols = ` аргумент байдаг ба үүнд пивот хийхгүй багануудын нэрстэй векторыг зааж өгдөг. 

```{r}
table_wide <- 
  df_wide %>% 
  pivot_wider(
    id_cols = age_cat,
    names_from = gender,
    values_from = n
  )

table_wide
```

Энэ хүснэгт уншихад ойлгомжтой тул тайлан мэдээнд хавсаргахад их тохиромжтой харагдаж байна. Хүснэгтийн өнгө үзэмжийг  **flextable**,  **knitr** зэрэг багцуудаар янзалж болно. Энэ талаар [Tables for presentation] хэсэгт илүү тайлбарласан.  

```{r}
table_wide %>% 
  janitor::adorn_totals(c("row", "col")) %>% # adds row and column totals
  knitr::kable() %>% 
  kableExtra::row_spec(row = 10, bold = TRUE) %>% 
  kableExtra::column_spec(column = 5, bold = TRUE) 
```

---


<!-- ======================================================= -->
## Нөхөх 

`pivot` хийгээд дараа нь `bind` хийсний дараа зарим тохиолдолд хэдэн нүднүүд хоосон үлдэж, нөхөх шаардлага гардаг.

<!-- ======================================================= -->
### Дата {.unnumbered}

Жишээ болгож дараах хоёр датасетийг авч үзье. Хоёул хэмжилтийн дугаар, байгууллагын нэр, тохиолдлын тоо агуулсан боловч хоёр дах нь үүн дээр нэмээнд `Year` гэсэн хувьсагчтай.

```{r}
df1 <- 
  tibble::tribble(
       ~Measurement, ~Facility, ~Cases,
                  1,  "Hosp 1",     66,
                  2,  "Hosp 1",     26,
                  3,  "Hosp 1",      8,
                  1,  "Hosp 2",     71,
                  2,  "Hosp 2",     62,
                  3,  "Hosp 2",     70,
                  1,  "Hosp 3",     47,
                  2,  "Hosp 3",     70,
                  3,  "Hosp 3",     38,
       )

df1 

df2 <- 
  tibble::tribble(
    ~Year, ~Measurement, ~Facility, ~Cases,
     2000,            1,  "Hosp 4",     82,
     2001,            2,  "Hosp 4",     87,
     2002,            3,  "Hosp 4",     46
  )

df2
```


Хэрэв бид `bind_rows()` -аар хоёр датаг нэгтгэвэл `Year` хувьсагчийн (эхний дата дах) мэдээлэлгүй нүднүүд `NA` болж хувирна.


```{r}
df_combined <- 
  bind_rows(df1, df2) %>% 
  arrange(Measurement, Facility)

df_combined

```

<!-- ======================================================= -->
### `fill()` {.unnumbered}

Энэ тохиолдолд `Year` бол цаг хугацааны явцыг харуулдаг хэрэгтэй хувьсагч тул байлгаж байх нь чухал. Ингэхдээ `fill()` функцын аргументэд нөхөх шаардлагатай баганууд болно чиглэлийг (энэ тохиолдолд дээш/**up**) зааж өгч тэдгээр хоосон нүднүүдийг *нөхөж* болно :

```{r}
df_combined %>% 
  fill(Year, .direction = "up")
```

Мөн датаг дахин эрэмбэлсний дараа нөхөх чиглэлийг доош чиглэлтэй болгож болно:

```{r}
df_combined <- 
  df_combined %>% 
  arrange(Measurement, desc(Facility))

df_combined

df_combined <- 
  df_combined %>% 
  fill(Year, .direction = "down")

df_combined
```

Одоо бид энэхүү хүснэгтийг ашиглан график байгуулах боломжтой боллоо:

```{r}
ggplot(df_combined) +
  aes(Year, Cases, fill = Facility) +
  geom_col()
```

Харин энэ хүснэгтээр датаг танилцуулахад тийм ч тохиромжтой биш тул урт, цэгцгүй датаг өргөн цэгцтэй хэлбэрт хүснэгтлэн харуулья: 

```{r}
df_combined %>% 
  pivot_wider(
    id_cols = c(Facility, Year, Cases),
    names_from = "Year",
    values_from = "Cases"
  ) %>% 
  arrange(Facility) %>% 
  janitor::adorn_totals(c("row", "col")) %>% 
  knitr::kable() %>% 
  kableExtra::row_spec(row = 5, bold = TRUE) %>% 
  kableExtra::column_spec(column = 5, bold = TRUE) 
```

Энэ тохиолдолд бид зөвхөн `Facility`, `Year`, `Cases` гэсэн гурван хувьсагчийг л оруулахыг зааж өгсөн ба хүснэгтийн бүтцэд таарахгүй учраас `Measurement` хувьсагчийг нэмж оруулаагүй: 

```{r}
df_combined %>% 
  pivot_wider(
    names_from = "Year",
    values_from = "Cases"
  ) %>% 
  knitr::kable()
```

## Нэмэлт мэдээллүүд

Энд хэрэгтэй хичээлүүд буй [tutorial](https://datacarpentry.org/r-socialsci/03-dplyr-tidyr/index.html)

