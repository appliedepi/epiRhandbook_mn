# Файл импортлож экспортлох

```{r, out.width=c('100%'), echo=F, message=F}
knitr::include_graphics(here::here("images", "Import_Export_1500x500.png"))
```

Энэ бүлэгт бид файлыг хэрхэн байрлуулж, импортлож, экспортлохыг тайлбарлана:

-   **rio** багц төрөл бүрийн файлыг хэрхэн чөлөөтэй `import()`, `export()` хийдэг эсэх;

-   **here** багцаар файлын байршлыг R төслийн үндсэн хавтастай хэрхэн холбоотойгоор заах;

-   Импортлох файлын төрлүүд:

    -   Excel--ийн sheet-үүд

    -   Цэгцгүй хүснэгтийн толгой болон мөр алгасах

    -   Google sheet-үүд

    -   Вебсайтад хэвлэгдсэн дата

    -   API -ууд

    -   *Хамгийн сүүлд* хэрэглэж байсан файлыг оруулах

-   Гараар өгөгдлийг оруулах

-   R файлын төрлүүд (RDS, RData)

-   Файл, графикыг хадгалж/экспортлох

<!-- ======================================================= -->

## Ерөнхий тойм

"Датасет" -ыг анх R -луу оруулахад R -ын орчинд шинэ *data frame* (хүснэгт) обьект үүсдэг. Үүнийг таны ажлын хавтсанд тодорхой хаяг/байршилтай, импортлогдсон (e.g. Excel, CSV, TSV, RDS) файл гэж үзнэ.

R -луу төрөл бүрийн өргөтгөлтэй файлаас гадна бусад статистикийн программ (SAS, STATA, SPSS) -ын файлыг бас оруулж болно. Мөн relational database (хамааралт өгөгдлийн санд)-т холбож болно.

R бас өөрийн өргөтгөлтэй:

-   RDS файл нь (.rds) нэг ширхэг R обьектийг хадгалдаг (ж: data frame). Ийм өртгөтгөлтэй файлын багана дах дата төрөл хэвээр хадгалдаг тул цэвэрлэгдсэн дата хадгалахад тохиромжтой. Энэ талаар [энэ хэсгээс](#import_rds) тодруулж үзнэ үү.

-   RData файл нь (.Rdata) хэд хэдэн обьект, эсвэл R workspace (ажлын талбай) -г бүтнээр нь хадгалдаг. Энэ талаар [энэ хэсгээс](#import_rdata) тодруулж үзнэ үү.

<!-- ======================================================= -->

## rio багц

**rio** багцаар импорт хийхэд их тохиромжтой. **rio** бол input/output (оролт/гаралт) -ын товчлол "R I/O" гэсэн үг юм.

Энэ багцын `import()`, `export()` функцууд төрөл бүрийн файлтай ажиллаж чаддаг (e.g. .xlsx, .csv, .rds, .tsv) . Эдгээр функцэд файлын байршлыг (өргөтгөлтэй нь хамт) зааж өгснөөр **rio** багц тухайн өргөтгөлд шаардлагатай тохируулгыг хийж, файл импортлогдож, экспортлогддог.

**rio** багцгүйгээр дээрх үйлдлийг хийхэд хэд хэдэн багц хамт ажиллах шаардлага гардаг. Багц болгон тус бүр өөр өргөтгөлийг уншина. Жишээ нь `read.csv()` (**base** R), `read.xlsx()` (**openxlsx** багц), `write_csv()` (**readr** багц) гэсэн функцууд байдаг. Эдгээрийг тэр болгон санаж хэрэглэхэд бэрхшээлтэй. Харин **rio** -ын `import()`, `export()` энэ үйлдлийг хялбар болгодог.

**rio**-ын `import()`,`export()` функцууд тухайн файлын өргөтгөлд шаардлагатай багцыг давхар дуудаж ажилуулдаг. **rio**-ын цаана нь давхар ажиллаж байдаг эдгээр багцыг бүлгийн төгсгөлд хүснэгтэд жагсааж харуулав. **rio** багц STATA, SAS, SPSS программын файлыг мөн зөөвөрлөдөг.

Харин shapefiles--г зөөвөрлөхөд өөр багц шаардлагатай. Энэ талаар [GIS үндсэн ойлголтууд](#GIS%20basics) хэсэгт дэлгэрэнгүй дурьдсан.

## **here** багц {#here}

Аливаа файлыг хаанаас олох, хаана хадгалахаа R-т хэлж, файлын зам үүсгэх үйлдлийг **here** багц, түүний `here()` функцээр хялбархан гүйцэтгэж болдог.

**here** багц R төсөл дэх файлуудын байршлыг тухайн R төслийн үндсэн хавтастай (хамгийн дээд түвшний хавтас) холбоотойгоор зааж өгдөг. R төслийг олон компьютерт дамжуулан хэрэглэж байхад дээрх үйлдэл их хэрэгтэй. **here** багц бүх хэрэглэгчдэд нийтлэг байршилтайгаар (R төслийн үндсэн хавтас) файлын замыг заадаг ба ингэснээр файлын зам компьютер болгонд өвөрмөц бичигдсэнээс болж үүсдэг хүндрэлээс сэргийлж чаддаг (жишээ нь "C:/Users/Laura/Documents...") .

R төсөлд `here()` -ын ажиллах зарчим:

-   Анх **here** багцыг ачаалах үед R төслийн үндсэн хавтас дотор ".here" гэсэн жижиг файл автоматаар үүсгэгдэж "чиглүүлэх", "холбох" үүрэг гүйцэтгэдэг.

-   R төслийн аль нэг дэд хавтаст файл хадгалахаар код бичих үед `here()` функцээр файлын зам үүсгэж энэхүү *чиглүүлэгчид холбож өгдөг*.

-   Файлын зам үүсгэхдээ *үндсэн хавтсан доторх* хавтаснуудын нэрсийг хашилт дотор оруулж, таслалаар тусгаарлаж бичих ба файлын нэрийг өргөтгөлтэй нь хамт бичнэ. Дор жишээ харуулав.

-   `here()` файлын замыг импорт, экспортын аль алинд нь ашиглаж болно.

Дараах `import()` функц дотор `here()` -ээр файлын зам бүтээсэн.

```{r, eval=F}
linelist <- import(here("data", "linelists", "ebola_linelist.xlsx"))
```

`here("data", "linelists", "ebola_linelist.xlsx")` гэсэн комманд үнэн хэрэг дээрээ *тухайн хэрэглэгчийн компьютерт өвөрмөц* файлын бүтэн замыг илэрхийлж байдаг:

    "C:/Users/Laura/Documents/my_R_project/data/linelists/ebola_linelist.xlsx"

`here()` -ээр бичигдсэн энэхүү комманд нь ямар ч компьютер байсан тухайн R төслийг олж чаддагаараа давуу талтай.

[***ЗӨВЛӨГӨӨ:*** ".here" файл хаана байрлаж буйг `here()` функцыг хоосон хаалттайгаар уншуулснаар олж болно.]{style="color: darkgreen;"}

**here** багцын талаарх дэлгэрэнгүй мэдээллийг [энэ линкээс](https://here.r-lib.org/) уншина уу.

<!-- ======================================================= -->

## Файлын зам

Датаг импортлож, экспортлоход тухайн файлын замыг зааж өгөх шаардлагатай. Үүнийг дараахь гурван аргаар хийх боломжтой:

1.  *Санал болгож буй арга*: **here** багцыг ашиглан файлын "холбоотой (relative)" замыг олно.

2.  Файлын "бүтэн" буюу "жинхэнэ (absolute)" замыг бичиж өгнө.

3.  Гараар (manuel) файлыг сонгох

### Файлын "холбоотой (relative)" зам {.unnumbered}

"Холбоотой (relative)" зам гэдэг нь файлын зам R төслийн үндсэн хавтастай холбоотой байхыг хэлнэ. Ингэснээр өөр компьютер дээр ажилласан ч файлыг хялбар олж болохуйц файлын замыг үүсдэг (жишээ нь R төслийг имэйлээр илгээх, эсвэл дундын драйв дээр ашиглах зэрэгт хэрэгтэй). [Дээр](#here) дурьдсанчлан "холбоотой (relative)" байршлыг зааж өгөхдөө **here** багцыг ашиглана.

`here()`-ээр файлын холбоотой замыг бичих жишээ дор харуулав. Жишээнд R төслийн үндсэн хавтаст "data" гэсэн хавтас байх ба энэ хавтаст дахиад дэд хавтас болох "linelists" гэсэн хавтас байгаа ба үүн дотор бидний ажиллах .xlsx өргөтгөлтэй файл байна.

```{r, eval=F}
linelist <- import(here("data", "linelists", "ebola_linelist.xlsx"))
```

### Файлын "жинхэнэ" зам {.unnumbered}

Файлын "бүтэн" замыг `import()` болон бусад төстэй функцэд оруулж өгч болдог. Гэвч энэ нь зөвхөн тухайн ажиллаж буй компьютерт л өвөрмөц зам үүсдэг тул *энэ аргыг хэрэглэхгүй байхыг зөвлөж* байна.

Файлын жинхэнэ замын жишээг дор харуулав. Энд Лаурагийн компьютер дэх "analysis" дэд хавтаст буй "data" дэд хавтас дотор "linelists" гэсэн дэд хавтас байна. Үүн дотор бидний ажиллаж буй .xlsx өргөтгөлтэй файл байрлаж байна.

```{r, eval=F}
linelist <- import("C:/Users/Laura/Documents/analysis/data/linelists/ebola_linelist.xlsx")
```

Файлын жинхэнэ замыг ашиглахад анхаарах зүйлс:

-   Өөр хүний компьютер дээр ажиллах үед файлын байршлын холбоос эвдэрдэг тул аль болох **файлын жинхэнэ замыг хэрэглэхээс зайлсхий.**

-   Урагшаа чиглэлтэй ташуу зураасыг (`/`) ашигла (Windows-д байнга хэрэглэгддэг ташуу зурааснаас ӨӨР болохыг анхаар)

-   Давхар ташуу зураасаар ( "//..." гэх мэт) эхэлдэг файлын зам **R программд танигддахгүй** байх өндөр магадлалтай ба ихэвчлэн алдаа заадаг. Ажлаа "нэртэй" эсвэл "J:", "C:" гэх мэт үсгээр дугаарласан дискэнд хадгалахыг зөвлөж байна. Энэ талаар [Directory interactions] хэсгээс нэмж тодруулна уу.

Дундын драйв дээрээс файл импортлоход тухайн файлын жинхэнэ зам бүх хэрэглэгчдэд яг адилхан бичигдсэн тохиодолд файлын жинхэнэ замыг ашиглаж болдлг.

[***ЗӨВЛӨГӨӨ:*** `\` тэмдэгтийг `/`-ээр түргэн солихын тулд Ctrl+f (Windows) дарж гарах цэснээс "In selection"-г сонго. Үүний дараа тэмдэгт солих үйлдэл хийж нэг дор солих боломжтой.]{style="color: darkgreen;"}

<!-- ======================================================= -->

### Гараар байршлыг сонгох {.unnumbered}

Гараар дата импортлоход дараах аргуудыг хэрэглэж болно:

1.  RStudio--ын Environment (орчин) табны "Import Dataset" (датасетийг импортлох)-г дарж, гарсан цэснээс дата төрлийг сонго.

2.  File/Import Dataset -г дарж өгөгдлийн төрлийг сонго.

3.  *base R*-ын `file.choose()` функцыг хоосон хаалттайгаар уншуулахад **pop-up цонхыг** гарч ирэх ба энэ үед компьютерээсээ файлыг гараар сонго. Жишээ:

```{r import_choose, eval=F}
# Гараар файл сонгох. Дараах коммандыг уншуулахад POP-UP цонх нээгдэнэ
# Гараар сонгосон файлын зам import() командын дотор бичигддэг.

my_data <- import(file.choose())
```

[***ЗӨВЛӨГӨӨ:*** **Pop-up цонх** RStudio-гийн цонхны АРД нээгдсэн байж болохыг анхаар.]{style="color: darkgreen;"}

## Дата импортлох

`import()`функцээр датасетийг хялбар импортлодог. Хаалтан дотор файлын замыг (файлын нэр өргөтгэлтэй нь хамт) хашилтанд оруулж бичихэд болно. Хэрэв `here()`-ээр файлын замыг зааж өгөх бол дээр дурьдсан жишээг харна уу. Дор жишээнүүд харуулав:

Таны "working directory" (ажлын хавтас)-д эсвэл R-ын үндсэн хавтаст байрлах csv файлыг оруулах:

```{r, eval=F}
linelist <- import("linelist_cleaned.csv")
```

R төсөл дэх "data" хавтсын "linelists" дэд хавтаст буй Excel файлын эхний sheet--ийг оруулах (файлын замыг `here()`-ээр зааж өгсөн):

```{r, eval=F}
linelist <- import(here("data", "linelists", "linelist_cleaned.xlsx"))
```

Файлын жинхэнэ байршлыг дуудаж датаг (.rds файл) импортлох:

```{r, eval=F}
linelist <- import("C:/Users/Laura/Documents/tuberculosis/data/linelists/linelist_cleaned.rds")
```

### Excel-ийн sheet- тэй ажиллах {.unnumbered}

Excel (.xlsx) файлыг `import()`-д импортлох үед default-оор эхний sheet импортлогддог. Өөр **sheet** --импортлох шаардлагтай тохиолдолд `import()` функцын `which=` аргументэд sheet-ийн нэрийг бич. Жишээ нь:

```{r eval=F}
my_data <- import("my_excel_file.xlsx", which = "Sheetname")
```

Файлын холбоотой замыг `here()`-ээр бичиж `import()` -д оруулаад `here()`--ийн хаалтыг хаасны дараа нэмэлтээр `which =` аргумент өгч үүндээ тухайн sheet --ийн нэрийг зааж өгдөг.

```{r import_sheet_here, eval=F}
# Файлын холбоотой замыг 'here' -ээр дууудаж Excel sheet-ийг импортлох
linelist_raw <- import(here("data", "linelist.xlsx"), which = "Sheet1")`  
```

R --ын хүснэгтийг Excel -ийн аль нэг sheet рүү (бусад sheet-ийг өөрчлөлгүйгээр ) *экспортлох* бол тусгай зориулалтын **openxlsx** гэх мэт багц ашигладаг. Энэ талаар [Directory interactions] эсвэл [at this github page](https://ycphs.github.io/openxlsx/) хэсгээс харна уу.

Excel-ийн .xlsb (binary хэлбэртэй Excel файл) файлыг **rio** багцаар импортолж болдоггүй. Ийм тохиолдолд .xlsb файлаа .xlsx болгон хувиргаж хадгалдаг. Эсвэл [this purpose](https://cran.r-project.org/web/packages/readxlsb/vignettes/read-xlsb-workbook.html) энэ зориулалтын **readxlsb** багцыг ашигладаг.

<!-- ======================================================= -->

### Дутуу утга {#import_missing .unnumbered}

Дата дах дутуу утгуудыг зааж өгөх шаардлага гардаг. R дутуу утгыг `NA` гэж бичдэг ([Missing data] гэсэн хэсэгт заасан). Харин таны датанд дутуу утгыг 99, "Дутуу", эсвэл хоосон зайгаар тэмдэглэсэн байх тохиолдол байдаг.

Ийм үед `import()` дотор `na =` -аргумент нэмж өөрийн дата дах дутуу утгын тэмдэглэгээг хашилтад оруулан бичнэ (тоогоор тэмдэглэсэн байсан ч гэсэн). Янз бүрийн дутуу утгуудыг зэрэг зааж өгөх бол `c()`функц ашиглан вектор хэлбэрээр оруулж болдог. Жишээг дор харуулав.

Жишээнд импортолж буй датанд дутуу утгыг "99" --ээр тэмдэглэсэн ба R -д оруулахдаа `NA` болгож хувиргаж байна.

```{r, eval=F}
linelist <- import(here("data", "my_linelist.xlsx"), na = "99")
```

Энэ жишээнд импортолж буй датаны "Дутуу", "" (хоосон нүд), эсвэл " "(нэг зай) гэж бичигдсэн бүх утгуудыг R-т `NA` болгож хувиргаж байна.

```{r, eval=F}
linelist <- import(here("data", "my_linelist.csv"), na = c("Missing", "", " "))
```

<!-- ======================================================= -->

### Мөр алгасах {.unnumbered}

Зарим мөрийг оруулалгүйгээр дата импортлох шаардлага гардаг. Үүнийг **rio** -ын `import()` функцийн `skip =` аргументийн тусламжтайгаар хйидэг (.xlsx зэрэг .csv файлтай ажиллаж буй үед). Ингэхдээ алгасах мөрийн тоог зааж өг.

```{r, eval=F}
linelist_raw <- import("linelist_raw.xlsx", skip = 1)  # толгой (header) мөрийг оруулалгүйгээр импортлоно
```

`skip =` зөвхөн нэг бүхэл тоон утга л авдаг ба дараалласан хэд хэдэн тоон утга оруулж **болдоггүй** (жишээ нь "2:10" гэх боломжгүй). Хүснэгтийг эхнээс дараалласан биш, энд тэнд байрлалтай мөрүүдийг алгасах бол датаг дахин импортлоод **dplyr** -ын `bind_rows()`--ыг хэрэглэдэг. Доор жишээнд ердөө 2 мөр алгасахыг харуулав.

### Хоёр дах толгой (header) мөртэй ажиллах {.unnumbered}

Заримдаа хүснэгтийн толгой хоёр мөрнөөс бүтсэн байдаг. Жишээ нь датаны "нэрсийн тайлбар" --ийг хоёр дах нүдэнд биччихдэг. Ийм датаг тэр чигээр нь импортловол бүх багана "character" хэлбэртэй болж хувирах эрсдэлтэй.

```{r, echo=F}
# УНШИГЧААС НУУЦ
####################
# хүснэгтийн хоёр дах толгойд "нэрсийн тайлбар"-ыг бичиж 2 дах мөрөнд байрлуул; 2. Хүснэгт болгож хадгал.
linelist_2headers <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds")) %>%         
        mutate(across(everything(), as.character)) %>% 
        add_row(.before = 1,
                #row_num = "000",
                case_id = "case identification number assigned by MOH",
                generation = "transmission chain generation number",
                date_infection = "estimated date of infection, mm/dd/yyyy",
                date_onset = "date of symptom onset, YYYY-MM-DD",
                date_hospitalisation = "date of initial hospitalization, mm/dd/yyyy",
                date_outcome = "date of outcome status determination",
                outcome = "either 'Death' or 'Recovered' or 'Unknown'",
                gender = "either 'm' or 'f' or 'unknown'",
                hospital = "Name of hospital of first admission",
                lon = "longitude of residence, approx",
                lat = "latitude of residence, approx",
                infector = "case_id of infector",
                source = "context of known transmission event",
                age = "age number",
                age_unit = "age unit, either 'years' or 'months' or 'days'",
                fever = "presence of fever on admission, either 'yes' or 'no'",
                chills = "presence of chills on admission, either 'yes' or 'no'",
                cough = "presence of cough on admission, either 'yes' or 'no'",
                aches = "presence of aches on admission, either 'yes' or 'no'",
                vomit = "presence of vomiting on admission, either 'yes' or 'no'",
                time_admission = "time of hospital admission HH:MM")
```

Ийм датасетын жишээг дор харуулав (эхний мөрөндөө нэрсийн тайлбартай).

```{r message=FALSE, echo=F}
# linelist датаг хүснэгтээр харуул
DT::datatable(head(linelist_2headers, 5), rownames = FALSE, filter="top", options = list(pageLength = 4, scrollX=T), class = 'white-space: nowrap' )
```

#### Хоёрдах толгой мөрийг арилгах {.unnumbered}

Дата импортлох үйлдлийг хоёр давтан хийснээр хоёр дах мөрийг арилгах боломжтой.

1) Датаг импортлоод баганын жинхэнэ нэрийг хадгал\
2) Датаг дахин импортлох ба ингэхдээ эхний *хоёр* мөрийг (толгой мөр, 2 дах мөр) алгасч оруул\
3) Эхэнд хадгалсан баганын нэрсээ мөр алгассан хүснэгтдээ холбож өг.

Баганын нэрийг хүснэгттэй холбодог үйлдлийн аргумент дата төрлөөс хамаарч өөр байдаг ( жишээ нь .csv, .tsv, .xlsx,). Энэ нь файлын төрлөөс хамаарч **rio** багц өөр функц ашигладагтай холбоотой. (дээрх хүснэгтээс харна уу).

**For Excel files:** (`col_names =`)

```{r, eval=F}
# Эхний удаагийн импорт хийх үйлдлээр зөвхөн нэрсийг хадгал;
linelist_raw_names <- import("linelist_raw.xlsx") %>% names()  # баганын нэрсийг хадгал

# Датаг дахин импортло; эхний 2 мөрийг алгасаад col_names = аргументэд өмнөх хадгалсан нэрсээ заа.
linelist_raw <- import("linelist_raw.xlsx",
                       skip = 2,
                       col_names = linelist_raw_names
                       ) 
```

**For CSV files:** (`col.names =`)

```{r, eval=F}
# Эхний удаагийн импорт хийх үйлдлээр зөвхөн нэрсийг хадгал;
linelist_raw_names <- import("linelist_raw.csv") %>% names() # баганын нэрсийг хадгал

# csv файлын аргумент 'col.names = ' болохыг анхаар
linelist_raw <- import("linelist_raw.csv",
                       skip = 2,
                       col.names = linelist_raw_names
                       ) 
```

**Нэмэлт хувилбар** - баганын нэрийг тусдаа коммандаар өөрчилж болно.

```{r, eval=F}
# R base –ийн 'colnames()' функцээр хүснэгтийн толгойд дахин нэр онооно.
colnames(linelist_raw) <- linelist_raw_names
```

#### Датанд нэрсийн тайлбар толь (data dictionary) үүсгэх {.unnumbered}

Бонус! хоёр дах мөрөнд нэрсийн тайлбар бичигдчихсэн байвал үүнийг нэрсийн тайлбар багана болгож хувиргах амархан. Энэ санааг [post](https://alison.rbind.io/post/2018-02-23-read-multiple-header-rows/) -д тайлбарласан байсан.

```{r}
dict <- linelist_2headers %>%             # эхлэл: эхний мөрөндөө тайлбартай linelist
  head(1) %>%                             # зөвхөн баганын нэрс болон нэрсийн тайлбарыг авч үлд
  pivot_longer(cols = everything(),       # бүх баганыг урт хэлбэрт шилжүүл
               names_to = "Column",       # шинэ үүссэн хоёр баганад нэр өг
               values_to = "Description")
```

```{r message=FALSE, echo=F}
DT::datatable(dict, rownames = FALSE, filter="top", options = list(pageLength = 4, scrollX=T), class = 'white-space: nowrap' )
```

#### Хоёр толгой мөрийг нэгтгэх {.unnumbered}

Хэрэв датасет боловсруулалт хийхээс өмнө *хоёр* толгой мөртэй байвал (баганын туслах гарчиг хоёр дах мөрөнд бичигдсэн г.м) "нэгтгэх", эсвэл хоёр мөрөн дэх утгыг хооронд нь нийлүүлэх шаардлага гардаг.

Дараах коммандыг өгснөөр эхний болон түүний дорх мөр нэтгэгдэж (paste) баганын нэр болж импортлогддог.

```{r, eval=F}
names(my_data) <- paste(names(my_data), my_data[1, ], sep = "_")
```

<!-- ======================================================= -->

### Google sheet-үүд {.unnumbered}

Google-ийн онлайн spreadsheet-ийг **googlesheet4** багцаар импортлодог. Энэ үед мөн хандах эрхээ баталгаажуулах шаардлагатайг анхаар.

```{r, eval=F}
pacman::p_load("googlesheets4")
```

Google sheet оруулах жишээг дор харуулав. Энэхүү коммандыг уншуулхад google account --ыг баталгаажуулах хүсэлт гарч ирдэг. Интернетийн браузерт гарч ирсэн цонх, pop-up -г дагаж биелүүлсний дараа Tidyverse API- багцууд таны Google Drive дээрх хүснэгтийг засаж, арилгах шинээр үүсгэх зөвшөөрөлтэй болдог.

Дорх хүснэгт "линкээр орсон хүн болгон үзэх боломжтой" ("viewable for anyone with the link") гэсэн тохируулгатай учир та импортлож үзэж болно.

```{r, eval=F}
Gsheets_demo <- read_sheet("https://docs.google.com/spreadsheets/d/1scgtzkVLLHAe5a6_eFQEwkZcc14yFUx1KgOMZ4AKUfY/edit#gid=0")
```

Тухайн sheet -ийн ID -г зааж өгсний дараа импортлогддог. ID нь URL-ын богино хэсэгт байрладаг:

```{r, eval=F}
Gsheets_demo <- read_sheet("1scgtzkVLLHAe5a6_eFQEwkZcc14yFUx1KgOMZ4AKUfY")
```

Дээрхтэй ижил үйлдэл хийдэг өөр нэгэн багц бол **googledrive**. Үүнийг ашиглаж Google sheet-ийг янзалж, арилгаж, шинээр үүсгэж болно. Энэ багцад `gs4_create()`,`sheet_write()` гэх мэт функцууд байдаг.

Энэ талаар дэлгэрүүлж заасан хичээл, материалуудыг дараах линкүүдээс үзнэ үү:\
[basic Google sheets importing tutorial](https://arbor-analytics.com/post/getting-your-data-into-r-from-google-sheets/)\
[more detailed tutorial](https://googlesheets4.tidyverse.org/articles/googlesheets4.html)\
[interaction between the googlesheets4 and tidyverse](https://googlesheets4.tidyverse.org/articles/articles/drive-and-sheets.html)

## Олон файлтай зэрэг ажиллах - импорт, экспорт, хуваах, нэгтгэх

Олон файлыг зэрэг импортлох, нэгтгэх, эсвэл олон Excel файлтай зэрэг ажиллах жишээг [Iteration, loops, and lists] хэсгээс харна уу. Энэ линкэд мөн хүснэгтийг хэрхэн хуваах, хуваасан хэсэг тус бүрийг экспортлох, Excel-ийн тусгай sheet болгон хадгалах талаар тайлбарласан.

<!-- ======================================================= -->

## Github-аас файл импортлох {#import_github}

Github-аас шууд R-луу дата импортлох нь хялбар, цөөн үйлдэлтэй байдаг. Дараах аргуудаар импортлоно:

### CSV файл {.unnumbered}

Github-аас .csv файлыг R-луу шууд R коммандаар хялбар импортлодог.

1)  Github --ийн агуулахыг нээнэ, импортлох файлаа байрлуулаад дээр нь дар\
2)  "Raw" товчийг дар ("raw" csv гэсэн дата харагдна, доор харуулав)\
3)  URL (вебхаяг)-г хуулж ав\
4)  Хуулсан URL --г хашилттанд хийж `import()` функцэд оруулж уншуул

```{r, out.width=c('100%', '100%'), fig.align = "left", echo=F}
knitr::include_graphics(here::here("images", "download_csv_raw.png"))
```

### XLSX файл {.unnumbered}

Зарим файл дах "Raw" датаг харж болдоггүй (.xlsx, .rds, .nwk, .shp гэх мэт).

1) Github --ийн агуулахыг нээ, импортлох файлаа байрлуулаад дээр нь дар

2) "Download" товчийг дар (доор зурагт харуулснаар)

3) Файлыг компьютертээ хадгалаад дараа нь R -луу импорт хий.

```{r , out.width=c('100%', '100%'), fig.align = "left", echo=F}
knitr::include_graphics(here::here("images", "download_xlsx.png"))
```

### Shapefiles {.unnumbered}

Shapefiles файл олон дэд бүрэлдэхүүн хэсгүүдтэй ба хэсэг тус бүр өөр өргөтгөлтэй. Нэг файл ".shp" гэсэн өргөтгөлтэй байхад нөгөө файл ".dbf", ".prj" гэх мэтээр өөр байдаг. Github-аас shapefile татахад дэд бүрэлдэхүүүн бүрийг тусдаа татаж аваад өөрийн компьютерт *ижил* хавтаст хийж хадгал. Github дээрх файл тус бүрийг "Download" товчийг дарж нэг бүрчлэн татаж ав.

Компьютерт хадгалагдсны дараа **sf** багцын `st_read()`--ээр shapefile --аа импорт хийнэ ([GIS basics] хэсэгт заасан буй). Та зөвхөн файлын зам болон ".shp" файлынхаа нэрийг зааж өгөхөд л болно (тухайн ".shp файлтай холбоотой бусад файлууд ижил хавтаст байрлаж байх шаардлагатай).

Дор жишээнд "sle_adm3" гэх shapefile олон янзын файлаас хэрхэн бүрэлддэгийг харуулав. Файл болгоноо Github -аас тусдаа татаж авах шаардлагатай.

```{r , out.width=c('100%', '100%'), fig.align = "left", echo=F}
knitr::include_graphics(here::here("images", "download_shp.png"))
```

<!-- ======================================================= -->

## Гараар дата оруулах

### Мөр болгоноор оруулах {.unnumbered}

**tidyverse** багцуудын нэг **tibble** багцын `tribble` функцийг хэрэглэ ([online tibble reference](https://tibble.tidyverse.org/reference/tribble.html)).

Баганын толгой *tilde* (`~`) тэмдэгтээр эхэлж буйг анхаар. Мөн багана болгон нэг төрлийн дата агуулсан байна (character, numeric гэх мэт.). Кодыг хялбар уншигддаг болгох үүднээс таб, зай авах, шинэ мөр эхлэх зэргээр кодоо тохируулж болно. Утга хооронд зай авах нь чухал биш, харин мөр болгоныг шинэ мөрнөөс эхэлж бичих хэрэгтэй. Жишээ:

```{r import_manual_row}
# датасетийг гараар мөр дагуу бичих
manual_entry_rows <- tibble::tribble(
  ~colA, ~colB,
  "a",   1,
  "b",   2,
  "c",   3
  )
```

Үүсгэсэн хүснэгт дараах байдлаар харагдна::

```{r, echo=F}
# үүсгэсэн шинэ датасетээ харуулах
DT::datatable(manual_entry_rows)
```

### Багана дагуу дата оруулах {.unnumbered}

Хүснэгт нь векторуудаас бүтдэг (вертикал багана) учир **base** R таныг багануудаа эхлэж үүсгээд дараа нь нэгтгэнэ гэж ойлгодог. Харин тархвар судлалын хувьд датаг ихэвчлэн эхэлж мөрийн дагуу оруулдаг онцлогтой (дээрх жишээ).

```{r import_manual_col}
# Бүх векторыг багана бүрээр бичиж оруул; багана бүрт нэр өг
PatientID <- c(235, 452, 778, 111)
Treatment <- c("Yes", "No", "Yes", "Yes")
Death     <- c(1, 0, 1, 0)
```

[***АНХААРУУЛГА:*** Бүх векторууд ижил урттай байх шаардлагатай (ижил тооны утгатай).]{style="color: orange;"}

Векторуудыг `data.frame()` функцээр нэгтгэдэг:

```{r}
# Векторын нэрсийг data.frame -д оруулснаар хүснэгт нэгтгэгднэ.
manual_entry_cols <- data.frame(PatientID, Treatment, Death)
```

Үүсгэсэн хүснэгт нь дараах байдлаар харагдна:

```{r, echo=F}
# үүсгэсэн шинэ датасетээ харуулах
DT::datatable(manual_entry_cols)
```

### Clipboard-оос хуулж авах {.unnumbered}

Clipboard -д хуулж авсан датаг дараах хоёр аргаар импорт хийдэг.

**clipr** багцын `read_clip_tbl()`--ыг ашиглан хүснэгт хэлбэрээр,`read_clip()`--ээр character хэлбэрээр импортлоно. Энэ хоёр функцын хаалтыг хоосон орхи.

```{r, eval=F}
linelist <- clipr::read_clip_tbl()  # clipboard дах датаг хүснэгт хэлбэрээр импорт хий 
linelist <- clipr::read_clip()      # character хэлбэрээр импорт хий
```

Системийн clipboard-д хуулагдсан бол **clipr**-ийг ашиглан амархан экспортолж болно. Экспорт хэсэгт дэлгэрүүлж бичсэн.

Мөн **base** R-ын `read.table()`--д `file ="clipboard"` гэсэн аргумент өгюөл дата хүснэгт хэлбэрээр импортлогддог.

```{r, eval=F}
df_from_clipboard <- read.table(
  file = "clipboard",  # "clipboard"-ийн файл гэдгийг заана
  sep = "t",           # tab, таслал зэргээр тусгаарлагчийг заана.
  header=TRUE)         # баганын эхний мөр толгой мөр мөн эсэхийг заана
```

## Хамгийн сүүлд хэрэглэж байсан файлыг импортлох

Та датанд тогтмол өөрчлөлт оруулдаг бол хамгийн сүүлд хэрэглэж байсан файлыг импортлодог код хэрэгтэй байдаг. Үүнийг гүйцэтгэх хоёр янзын арга буй:

-   файлын нэр дээрх огнооны дагуу файлыг сонгох\
-   файлын метадатан дах огнооны дагуу файлыг сонгох (хамгийн сүүлд хийсэн өөрчлөлтийн огноо)

### Файлын нэр дээрх огноо {.unnumbered}

Үүнийг хийхэд дараах гурван нөхцөл бүрдсэн эсэх хамаатай:

1.  Файлын нэр дээр бичигдсэн огноонд итгэлтэй байх
2.  Огноо тоогоор бичигдсэн ба *ерөнхийдөө* ижил форматтай байна (дараалал нь жил, сар, өдөр гэх мэт)
3.  Файлын нэрэнд тоогоор огнооноос өөр зүйл тэмдэглээгүй байх.

Бид энд алхам бүрийг тайлбарласны дараа нэтгэж харуулав.

Эхлээд **base** R-ын `dir()`-- ийг хэрэглэж, сонгосон хавтас доторх файлын зөвхөн нэрсийг авна. [Directory interactions] хэсгээс `dir()` --ийн талаар харна уу. R төслийн хавтас дах "data" хавтасны "example" хавтсанд буй "linelists" хавтсыг хэрхэн дуудахыг дор жишээнд харуулав.

```{r}
linelist_filenames <- dir(here("data", "example", "linelists")) # хавтсан дах файлын нэрсийг ав
linelist_filenames                                              # хэвлэ
```

Файлын нэрсийг вектор болгож авсны дараа огноотой хэсгийг салгаж авахын тулд **stringr** багцын `str_extract()`-т дараах regular expression-г оруулж комманд өгнө. Энэ коммандаар файлын нэрэнд буй тоотой бүх хэсгийг салгаж авч болно (дунд нь орсон зураас, ташуу зураас зэргийг оруулаад). **stringr** багцын талаар дэлгэрүүлж [strings болон characters] -аас уншиж болно.

```{r}
linelist_dates_raw <- stringr::str_extract(linelist_filenames, "[0-9].*[0-9]") #тоо болон тэмдэгтүүдийг салгаж авна.
linelist_dates_raw  # хэвлэ
```

Файлын нэрэн дээрх огнооны формат ижил төстэй (дараалал нь жил, сар, өдөр гэх мэт ), жил нь 4 цифртэйгээр бичигдсэн байвал, **lubridate** багцын хувиргагч функцуудыг (`ymd()`,`dmy()`, `mdy()`) ашиглан амархан хувиргалт хийж болдог. Эдгээр функц зураас, ташуу зураас, хоосон зай зэргийг ажралгүй зөвхөн огнооны дэс дараалаллыг анхаардаг. Энэ талаар [Working with dates] хэсгээс нэмж үзнэ үү.

```{r}
linelist_dates_clean <- lubridate::ymd(linelist_dates_raw)
linelist_dates_clean
```

**base** R -ын `which.max()`-аар огноонуудын индекс байрлалаас (1 дүгээр, 2 дугаар, 3 дугаар) хамгийн ихийг нь дууддаг. Дор жишээнд "case_linelist_2020-10-08.xlsx"-ыг (хамгийн сүүлд хэрэглэсэн файл) 6 дугаар файл гэж зөв дугаарлагдсан байна.

```{r}
index_latest_file <- which.max(linelist_dates_clean)
index_latest_file
```

Эдгээр коммандыг нэгтгэж доор харуулав. Энэхүү pipe дараалаллын төгсгөлд тухайн pipe -аар бичигдэж буй обьектийг илэрхийлэхдээ `.` тэмдэгтээр бичсэнийг анхаарна уу. Энэ үед бичигдэж буй обьект 6 гэсэн тоо . `dir()` --ээр үүсгэгдсэн файлын нэрстэй векторын 6 дугаар элэментийг гаргаж авахын тулд дээрх тэмдэглэгээг давхар хаалтанд оруулж бичсэн, .

```{r}
# Багцуудыг ачааллах
pacman::p_load(
  tidyverse,         # дата менежмент
  stringr,           # strings/characters-тай ажиллах
  lubridate,         # огноотой ажиллах
  rio,               # импорт / экспорт
  here,              # файлын холбоотой зам
  fs)                # файлын байрлалуудын харилцан үйлчлэл

# сүүлийн хэрэглэсэн файлын нэрийг салгаж ав
latest_file <- dir(here("data", "example", "linelists")) %>%  #файлын нэрсийг "linelists" дэд хавтаснаас ав               
  str_extract("[0-9].*[0-9]") %>%       # нэрнүүд дэх огноог салгаж ав (тоогоор бичигдсэн)
  ymd() %>%                             # тоон утгыг огноо болго (жил-сар-өдөр форматтай тохиолдолд)
  which.max() %>%                   # хамгийн их огнооны индекс байрлал (хамгийн сүүлд хэрэглэсэн файл)
  dir(here("data", "example", "linelists"))[[.]]          # хамгийн сүүлд хэрэглэсэн linelist-ийн файлын нэрийг дуудах

latest_file  # сүүлд хэрэглэсэн файлын нэрийг хэвлэ
```

Одоо энэхүү нэрээ `here()` багцад оруулж тухайн файлын холбоотой замыг гүйцээж бич:

```{r, eval=F}
here("data", "example", "linelists", latest_file) 
```

Одоо хамгийн сүүлд хэрэглэж байсан файлыг импортлох боломжтой:

```{r, eval=F}
# импорт
import(here("data", "example", "linelists", latest_file)) # импорт
```

### Файлын метадата ашиглах {.unnumbered}

Та файлын нэрэн дээр огноо бичээгүй (эсвэл та нэрэн дээрх огноонд итгэлгүй) тохиолдолд тухайн файлын метадатанаас хамгйин сүүлд ашигласан огноог олж болно. Файлын сүүлд ашигласан огноо, файлын зам зэрэг мэдээллийг шалгахдаа **fs** багцын функцээс хэрэглэдэг.

Дараах жишээнд сонгосон хавтсыг **fs**-ын `dir_info()` -д оруулж бичсэн. Сонгосн хавтас нь R төслийн хавтсан дах "data" хавтасны "example" дэд хавтас доторх "linelists" хавтас юм. Ингэснээр файл тус бүрт нэг мөртэй, `modification_time`,`path` (файлын метадата) гэсэн багануудтай хүснэгт бий болно. [Directory interactions] --д жишээг илүү дэлгэрэнгүй харуулсан.

Үүний дараа хүснэгийг `modification_time` --аар нь эрэмбэлээд **base** R-ын `head()` -ээр зөвхөн эхний мөр буюу хамгийн сүүлд ашигласан файлтай мөрийг авч үлдэж болно. Дараа нь хүснэгтийн `path` баганыг **dplyr** -ын `pull()`--д оруулж сүүлд хэрэглэсэн файлын замыг гаргаж авна. Эцэст нь энэ файлын замыг `import()`-д оруулна. Импортлогдсон файлыг `latest_file` гэж хадгална.

```{r, eval=F}
latest_file <- dir_info(here("data", "example", "linelists")) %>%  # энэ байршилд буй бүх файлын метадатаг цуглуул 
  arrange(desc(modification_time)) %>%      # өөрчлөлт оруулсан хугацаагаар нь эрэмблэ
  head(1) %>%                               # зөвхөн толгой мөрийг авч үлд
  pull(path) %>%                            # зөвхөн файлын замыг авч үлд
  import()                                  # файлыг импорт хий

```

<!-- ======================================================= -->

## APIs {#import_api}

Автомат Программчлагдсан Интерфэйс (Automated Programming Interface) (API) --ыг ашиглан дата авах хүсэлтийг шууд вебсайтад нь явуулдаг. API гэдэг нь программ бие биетэйгээ харилцан үйлчлэх боломжийг бүрдүүлж буй дүрмийн багцыг хэлнэ. Үйлчлүүлэгч (та) "хүсэлтээ" илгээсний дараа мэдээлэл агуулсан "хариуг" хүлээж авдаг. R дээр **httr**, **jsonlite** багцууд энэ үйлдлийг гүйцэтгэдэг.

API -г идэвхижүүлсэн вебхуудас бүр өөрийн дүрмийг танилцуулсан байдаг. Зарим вебхуудас нийтэд нээлттэй, хэн ч авч болохоор байхад зарим вебсайт ялангуяа ID, нууц үг хэрэглэдэг платформуудаас мэдээлэлэл авахын тулд баталгаажуулалт хэрэгтэй байдаг.

API --аар мэдээлэл импортлоход мэдээж сүлжээнд холбогдсон байна. API ашиглан мэдээлэл импортлохыг товч жишээгээр харуулж, нэмэлт линкийг дор бичлээ.

*Тэмдэглэл: мэдээлэл вебхуудаст ямар ч API гүйгээр тавигдсан*\* *байж болох* ба ийм тохиолдолд татаж авахад хялбар байх талтай. Жишээ нь сайтын URL-г `import()` дотор оруулснаар CSV файлыг шууд татаж авах боломжтой байж болно. Энэ талаар [importing from Github](#import_github) -д мөн дурьдсан\*

### HTTP request {.unnumbered}

API солилцоог ихэвчлэн HTTP хүсэлтээр гүйцэтгэдэг. HTTP гэдэг нь Hypertext Transfer Protocol --ын товчлол. Энэ бол үйлчлүүлэгч, сервер хоёрын хүсэлт/хариу солилцон явуулахад ашигладаг үндсэн формат юм. API -ын төрлөөс хамаарч оролт/гаралт (input/output) нь бага зэрэг өөр байх боловч үндсэн процесс нь адил. Энэ нь хэрэглэгчээс ирж буй лавлагаа, асуумжтай "Хүсэлт" (ихэвчлэн HHTP хүсэлт) ба хүсэлтийн статус, хариу мэдээллийг агуулсан "Хариулт"-аас бүрддэг.\
*HTTP хүсэлтийн* зарим бүрдэл хэсгүүд:

\- API -ын эцсийн цэгийн URL\
- "Аргачлал" (эсвэл "Үйл үг")\
- Толгой хэсэг\
- Бие хэсэг

HTTP хүсэлтийн "аргачлал" гэдэг нь таны үйлдэх гэж буй үйлдлийн нэр. Нийтлэг хэрэглэгддэг хоёр HTTP аргачлал бол `GET` болон `POST`. Бусад аргачлалд `PUT`,`DELETE`,`PATCH` зэрэг орно. R -луу дата импорт хийхэд ихэвчлэн `GET`-ийг хэрэглэдэг.

Хүсэлт гаргасны дараа таны компьютер хариуг хүлээж авна. Ирэх хариулт таны илгээсэн мэдээлэлтэй төстэй форматаар буцаж ирнэ. Үүнд URL, HTTP статус (Статусыг 200 байлгах нь чухал!), файлын төрөл, хэмжээ болон гол авахыш хүссэн мэдээлэл ордог. Та ирсэн мэдээллийг ялгаж, R --ын орчинруу хүснэгт хэлбэрээр оруулах шаардлагатай.

### Багцууд {.unnumbered}

R дээр HTTP хүсэлт гаргахад **httr** багцыг нийтлэг хэрэглэдэг. Энэ багцыг ашиглахад Веб API мэдлэг бага шаардагддаг ба компьютер программчлалын хэллэг сайн мэдэхгүй хүмүүс хэрэглэх боломжтой. Хэрэв HTTP хүсэлт .json хэл дээр бичигдсэн бол **jsonlite**--ашиглаж хариу мэдээллийг задалж болно.

```{r, eval=F}
# багцыг ачааллана
pacman::p_load(httr, jsonlite, tidyverse)
```

### Олон нийтэд нээлттэй дата {.unnumbered}

Дараах жишээнд HTTP хүсэлт гаргахыг харуулав. Жишээг [the Trafford Data Lab](https://www.trafforddatalab.io/open_data_companion/#A_quick_introduction_to_APIs) линк дээрх хичээлээс хуулбарлав. Энэ нлинкэд API --ын хичээл, дасгалууд олон бий.

Жишээ хувилбар: Бид Их Британийн Траффорд хотын түргэн хоолны газруудын жагсаалтыг импортлох хэрэгтэй болов. Энэ датаг Их Британийн хоолны ариун цэврийн үнэлгээний мэдээг боловсруулдаг Хоолны Стандартын Агентлагийн API-д нэвтэрснээр авч болох юм. Бидний хүсэлт гаргах параметрууд:

-   HTTP үйл үг: GET\
-   API --ийн эцсийн цэг URL: <http://api.ratings.food.gov.uk/Establishments>\
-   Сонгосон параметрүүд: нэр, хаяг, уртраг, өргөрөг, бизнессийн төрлийн дугаар, үнэлгээний төрөл, зөвшөөрөл өгөгчийн дугаар\
-   Толгой: "x-api-version", 2\
-   Өгөгдлийн формат(s): JSON, XML\
-   Дүрэм: <http://api.ratings.food.gov.uk/help>

Кодыг дараах маягаар бичнэ:

```{r, eval=F, warning=F, message=F}
# Хүсэлтээ бэлд
path <- "http://api.ratings.food.gov.uk/Establishments"
request <- GET(url = path,
             query = list(
               localAuthorityId = 188,
               BusinessTypeId = 7844,
               pageNumber = 1,
               pageSize = 5000),
             add_headers("x-api-version" = "2"))

# server –т гарах алдааг хянах  ("200" байвал сайн!)
request$status_code

# хүсэлтийг илгээж, хариуг үнэлж, хүснэгт болгон хувирга
response <- content(request, as = "text", encoding = "UTF-8") %>%
  fromJSON(flatten = TRUE) %>%
  pluck("establishments") %>%
  as_tibble()
```

Ингээд мөр бүрт нэг түргэн хоолны газрын мэдээлэл агуулсан `response` дататай болох ба үүнийг та янзалж болохоор боллоо.

### Баталгаажуулалт шаардлагатай үед {.unnumbered}

Зарим API-руу нэвтрэхийн тулд та өөрийгөө мөн эсэхийг баталгаажуулах шаардлагатай байдаг. Ингэснээр хязгаарлалттай мэдээлэлд нэвтрэх эрх авна. Энэ үед эхлээд хэрэглэгчийн нэр, нууц үг, код зэргийг POST -аргаар явуулдаг. Ингэснээр нэвтрэх эрх (token) авч улмаар GET аргаар хүсэлт явуулж хүссэн датагаа авдаг.

Доорх жишээнд *Go.Data* хэмээх өвчний дэгдэлтийг судалдаг аппликэйшнээс лавлагааг хэрхэн татаж авах талаар харуулав. *Go.Data* веб front-end болон дата цуглуулах зориулаттай гар утасны аппликэйшн хоёрын бүх харилцан үйлдэлд API ашигладаг. *Go.Data*-г дэлхий даяар ашиглагддаг боловч өвчний дэгдэлтийн талаарх мэдээлэл нууцлалтай учраас өөрийгөө мөн эсэхийг баталгаажуулсны үндсэн дээр зөвхөн *өөрийн* дэгдэлтийн мэдээлэлд орох эрхтэй болдог.

Дараах жишээнд *Go.Data*--ын **httr** болон **jsonlite** -аар API-тай харьцаж дэгдэлтийн үеийн хавьтагсдын датаг импорт хийхийг харуулав.

```{r, eval=F}
# баталгаажуулалт
url <- "https://godatasampleURL.int/"           # Go.Data –н зөв url
username <- "username"                          # Go.Data -ийн хэрэглэгчийн нэр  
password <- "password"                          # Go.Data –ын нууц үг
outbreak_id <- "xxxxxx-xxxx-xxxx-xxxx-xxxxxxx"  # Go.Data дахь дэгдэлтийн ID 

# Нэвтрэх эрх, тасалбар (token)
url_request <- paste0(url,"api/oauth/token?access_token=123") # үндсэн URL хүсэлтийг тодорхойл


# хүсэлтийг бэлд
response <- POST(
  url = url_request,  
  body = list(
    username = username,    # дээр хадгалсан хэрэглэгчийн нэр, нууц үгээ ашиглан орох эрхийг баталгаажуулна                     
    password = password),                                       
    encode = "json")

# хүсэлтийг илгээж, ирсэн хариуг задал
content <-
  content(response, as = "text") %>%
  fromJSON(flatten = TRUE) %>%          # сүлжилдсэн JSON-г нэгтгэ
  glimpse()

# Хариултад ирсэн нэвтрэх эрх (token)-ийг хадгал
access_token <- content$access_token    # нэвтрэх эрхийг хадгалснаар дараагийн API –ийн үйлдлүүд хийгдэх боломжтой болно

# Дэгдэлтийн хавьтлуудын өгөгдлийг импортлох
# нэвтрэх эрх (token)-ийг хэрэглэ
response_contacts <- GET(
  paste0(url,"api/outbreaks/",outbreak_id,"/contacts"),          # GET хүсэлт
  add_headers(
    Authorization = paste("Bearer", access_token, sep = " ")))

json_contacts <- content(response_contacts, as = "text")         # текстийг JSON луу хувирга
contacts <- as_tibble(fromJSON(json_contacts, flatten = TRUE))   # JSON –г tibble (хүснэгт) -руу хувирга
```

[***АНХААРУУЛГА:*** API --ийн зөвшөөрөл шаардлагатай вебсайтаас том хэмжээний дата татаж байх явцад сайт завсарлага авч үйлдэл зогсох магадлалтай. Үүнээс сэргийлж нэвтрэх эрхийг (access_token) API GET хүсэлт болгоны өмнө эргүүлж татах хэрэгтэй ба мөн асуумжыг хязгаарлах эсвэл шүүлтүүр ашиглаж болно.]{style="color: orange;"}

[***TIP:*** The `fromJSON()` function in the **jsonlite** package does not fully un-nest the first time it's executed, so you will likely still have list items in your resulting tibble. You will need to further un-nest for certain variables; depending on how nested your .json is. To view more info on this, view the documentation for the **jsonlite** package, such as the [`flatten()` function](https://rdrr.io/cran/jsonlite/man/flatten.html).]{style="color: darkgreen;"}

Нэмэлт мэдээлэл, зааврыг [LoopBack Explorer](https://loopback.io/doc/en/lb4/index.html), [Contact Tracing] хуудас эсвэл [Go.Data Github repository](https://worldhealthorganization.github.io/godata/api-docs) доторх API зөвлөгөөнөөс харна уу.

[here](https://httr.r-lib.org/articles/quickstart.html) линкээс **httr** багцын талаар уншна уу.

Мөн энэхүү хэсгийг бичихэд [this tutorial](https://www.dataquest.io/blog/r-api-tutorial/) болон [this tutorial](https://medium.com/@traffordDataLab/querying-apis-in-r-39029b73d5f1) линк дэх хичээлээс ашигласан.

<!-- ======================================================= -->

## Экспорт

### **rio** багцаар экспортлох {.unnumbered}

**rio** -ын `export()` функц `import()` тэй ижил хэрэглэгддэг. Эхлээд хадгалах гэж буй R обьектоо (`linelist` гэх мэт) бичээд, араас нь шинээр үүсгэж буй файлын нэрийг өргөтгөлтэй нь хамт хашилтанд оруулж бичнэ. Жишээ:

Доорх жишээгээр `linelist` гэсэн хүснэгтийг Excel хүснэгт болгож R-ийн үндсэн ажлын хавтаст хадгалахыг харуулав.

```{r, eval=F}
export(linelist, "my_linelist.xlsx") # ажлын хавтаст хадгалагдна
```

Дээрх linelist хүснэгтийг csv файл болгож хадгалая гэвэл дээрх кодон дах өргөтгөлийг өөрчлөхөд л болно. Үүнийгээ мөн `here()` -аар файлын замыг нь зааж хадгална:

```{r, eval=F}
export(linelist, here("data", "clean", "my_linelist.csv"))
```

### Clipboard-д экспорт хийх {.unnumbered}

Хүснэгтийг өөрийн компьютерийн "clipboard" --д экспорт хийхийн тулд (дараагаар нь Excel, Google spreadsheet -руу орууулах зориулалтаар) **clipr** -ын `write_clip()` -ыг ашиглана.

```{r, eval=F}
# linelist хүснэтгийг системийн clipboard -д экспортлох
clipr::write_clip(linelist)
```

## RDS файлууд {#import_rds}

Хүснэгтийг .csv, .xlsx зэрэг өртгөтгөлөөс гадна .rds өргөтгөлөөр экспортлож болно. Энэ нь зөвхөн R --т өвөрмөц ба тухайн датаг R дээр дахин хэрэглэх нь тодорхой бол энэ өргөтгөлөөр хадгалах нь тохиромжтой.

Багануудын дата төрөл хэвээр хадгалагдсан байдаг тул импорт хийхэд дахин янзалж, цэвэрлэх шаардлагагүй (Excel, CSV файлууд дээр энэ үйлдлийг хийх нь толгойны өвчин болдог!). Мөн файлын хэмжээ багасгадаг учир том хэмжээний дата импорт, экспорт хийхэд тохиромжтой.

Жишээ нь та тархвар судлалын багтай ажиллаж байлаа гэж бодъё. Тэдний ГИС (GIS)-ийн багт газрын зураг үүсгүүлэхээр файл явуулах бол .rds хэлбэрээр явуулбал оновчтой (тэд бас R хэрэглэдэг бол)! Учир нь багана тус бүрийн дата төрөл өөрчлөгддөггүй тул тэдний хийх ажлыг хөнгөвчилж өгдөг.

```{r, eval=F}
export(linelist, here("data", "clean", "my_linelist.rds"))
```

<!-- ======================================================= -->

## Rdata файл ба list-үүд {#import_rdata}

`.Rdata` файлууд олон R обьектыг зэрэг хадгалдаг. Тухайлбал олон хүснэгт, математик загварын үр дүнгүүд, list-үүд зэрэг файлууд хадгалагддаг. Энэ нь аливаа төсөл дээр хамтран ажиллаж, хоорондоо олон файл солилцож өөрчлөх шаардлагатай тохиолдолд их хэрэгтэй байдаг.

Жишээнд "my_objects.Rdata" хэмээх файл дотор олон R обьектуудыг оруулан экспортолж буйг харуулав.

```{r, eval=F}
rio::export(my_list, my_dataframe, my_vector, "my_objects.Rdata")
```

Тэмдэглэл: list импорт хийх үед **rio** -ын `import_list()`--ыг ашигласнаар list-ийн бүтэц, агууламжийг яг хэвээр нь хадгалах боломжтой.

```{r, eval=F}
rio::import_list("my_list.Rdata")
```

<!-- ======================================================= -->

## График, зураг хадгалах

`ggplot()`-ээр бүтээсэн график хадгалах талаар [ggplot basics] хэсэгт дэлгэрэнгүй заасан буй.

Товчхондоо графикийг хэвлэсний дараа `ggsave("my_plot_filepath_and_name.png")` коммандаар хадгална. Хамгийн сүүлд хэвлэгдсэн графикийг хадгалахдаа үүсгэж буй файлын нэрийг (өргөтгөлтэй нь хамт ) бичиж болно, эсвэл өмнө нь хадгалагдсан байсан график дээр өөрчлөлт хийн хадгалж буй бол нэрийг нь `plot =` аргументэд шууд зааж болно. Графикийн өргөн, урт, нэгж, нарийвчлал зэргийг `width =`,`height =`,`units =`,`dpi =` аргументуудаар тохируулж болно.

Халдварын тархалт харуулдаг тор хэлбэрийн (network) график хадгалах талаар [Transmission chains] хуудаст оруулсан.

<!-- ======================================================= -->

## Эх сурвалж материал

[R Data Import/Export Manual](https://cran.r-project.org/doc/manuals/r-release/R-data.html)\
[R 4 Data Science chapter on data import](https://r4ds.had.co.nz/data-import.html#data-import)\
[ggsave() documentation](https://ggplot2.tidyverse.org/reference/ggsave.html)

Дараах хүснэгтийг **rio** -ын онлайн [vignette](https://cran.r-project.org/web/packages/rio/vignettes/rio.html) --ээс авсан. Энэхүү хүснэгтээр **rio** багцын импорт, экспорт хийхдээ файлын өргөтгөлтэй холбоотойгоор зэрэг ажиллуулдаг багцууд, эдгээр нь **rio**-ын default -д орсон эсэхийг харуулав. .

+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Формат                              | Өргөтгөл                | Импорт хийх багц     | Экспорт хийх багц | Default-аар суулгагддаг эсэх |
+=====================================+=========================+======================+===================+==============================+
| Comma-separated data                | .csv                    | data.table `fread()` | data.table        | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Pipe-separated data                 | .psv                    | data.table `fread()` | data.table        | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Tab-separated data                  | .tsv                    | data.table `fread()` | data.table        | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| SAS                                 | .sas7bdat               | haven                | haven             | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| SPSS                                | .sav                    | haven                | haven             | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Stata                               | .dta                    | haven                | haven             | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| SAS                                 | XPORT                   | .xpt                 | haven             | haven                        |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| SPSS Portable                       | .por                    | haven                |                   | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Excel                               | .xls                    | readxl               |                   | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Excel                               | .xlsx                   | readxl               | openxlsx          | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| R syntax                            | .R                      | base                 | base              | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Saved R objects                     | .RData, .rda            | base                 | base              | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Serialized R objects                | .rds                    | base                 | base              | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Epiinfo                             | .rec                    | Гадны                |                   | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Minitab                             | .mtp                    | Гадны                |                   | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Systat                              | .syd                    | Гадны                |                   | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| "XBASE"                             | database files          | .dbf                 | Гадны             | Гадны                        |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Weka Attribute-Relation File Format | .arff                   | foreign              | Гадны             | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Data Interchange Format             | .dif                    | utils                |                   | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Fortran data                        | no recognized extension | utils                |                   | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Fixed-width format data             | .fwf                    | utils                | utils             | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| gzip comma-separated data           | .csv.gz                 | utils                | utils             | Тийм                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| CSVY (CSV + YAML metadata header)   | .csvy                   | csvy                 | csvy              | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| EViews                              | .wf1                    | hexView              |                   | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Feather R/Python interchange format | .feather                | feather              | feather           | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Fast Storage                        | .fst                    | fst                  | fst               | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| JSON                                | .json                   | jsonlite             | jsonlite          | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Matlab                              | .mat                    | rmatio               | rmatio            | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| OpenDocument Spreadsheet            | .ods                    | readODS              | readODS           | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| HTML Tables                         | .html                   | xml2                 | xml2              | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Shallow XML documents               | .xml                    | xml2                 | xml2              | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| YAML                                | .yml                    | yaml                 | yaml              | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
| Clipboard default is tsv            |                         | clipr                | clipr             | Үгүй                         |
+-------------------------------------+-------------------------+----------------------+-------------------+------------------------------+
